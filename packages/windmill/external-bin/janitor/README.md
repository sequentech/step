<!--
SPDX-FileCopyrightText: 2024 Felix Robles <felix@sequentech.io>

SPDX-License-Identifier: AGPL-3.0-only

-->
# janitor

Janitor is an conversion tool. It converts a sql dump and an excel file
into an election event configuration that can be imported through the
admin-portal.
 
## Installation

### Offline (Windows)

First follow the instructions to install and configure the Sequent Step 
Platform.

Then, Open the Windows PowerShell and navigate to the `packages` folder. Once
there, install Python and Pip with the following command:

```bash
wsl sudo dpkg -i *.deb
```

Then you can install the pip project dependencies with:

```bash
pip install --no-index --find-links=python_packages -r requirements.txt
```

### Online

Before using it, you need to configure the python environment. In ubuntu, do:

```bash
cd janitor
source ./setup.py
```

## Configuration

You'll need to add the COMELEC keycloak template. Upload it to 
`janitor/templates/COMELEC/keycloak.hbs`

## Use

The script has two inputs, a postgres dump file (.sql), and an excel (.xls) file.
You can use the example files hereby included:

```bash
cd janitor
python3 ./run.py import-data import-data/10-11-2024-field-test-preparations.xlsx
```

The output files are:
- `output/election_config.json`. This is the election event json that you
	can import in the admin portal.
- `logs/process_log.log`. Logs generated by the tool.
  
The tool also prints some output to provide feedback on the process.

## Voters

In order to export the voters, add a flag:

- `--voters` will create both the election event JSON file as well as the voters CSV file.
- `--only-voters` will create only the voters CSV file.

For example:


```bash
cd janitor
python3 ./run.py ./import-data/ovcs_ver7.sql ./import-data/29-09-2024-event-import.xlsx --only-voters
```

Will create the output files:

The output files are:
- `output/voters.csv`. This is the voters csv that you
	can import in the admin portal.
- `logs/process_log.log`. Logs generated by the tool.

## Extract ezip

After downloading the exported election event as a zip, with a name and with the password provided
by the admin portal, extract the ezip with this command (replace the name/password):

	openssl enc -aes-256-cbc -d -in <event-filename>.ezip  -out <event-filename>.zip -pass pass:"<pass>" -md md5

## tenant configuration

You can change the tenant id in the file `janitor/config/baseConfig.json`.
