// SPDX-FileCopyrightText: 2024 Sequent Tech Inc <legal@sequentech.io>
//
// SPDX-License-Identifier: AGPL-3.0-only

use anyhow::Result;
use chrono::Local;
use dotenv::dotenv;
use sequent_core::util::init_log::init_log;
use serde_json::Value;
use std::fs;
use std::path::PathBuf;
use structopt::StructOpt;
use tracing::event;
use tracing::Level;
use windmill::services::providers::pdf_renderer::PdfRenderer;

#[derive(Debug, StructOpt)]
#[structopt(
    name = "test-pdf",
    about = "Test the PDF renderer provider",
    setting = structopt::clap::AppSettings::ColoredHelp,
)]
struct Opt {
    input: String,
}

#[tokio::main]
async fn main() -> Result<()> {
    dotenv().ok();
    init_log(true);

    // Log all environment variables for debugging
    event!(Level::INFO, "Current environment variables:");
    for (key, value) in std::env::vars() {
        if key.contains("PDF") {
            event!(Level::INFO, "{}: {}", key, value);
        }
    }

    // Only set the binary path
    std::env::set_var(
        "PDF_LAMBDA_BINARY_PATH",
        "/workspaces/step/packages/orare/doc_renderer",
    );

    // Single-line test input
    let test_input = r#"{"html":"<html><head><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Arial',sans-serif;line-height:1.6;color:#333;padding:40px}.header{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);color:white;padding:30px;border-radius:10px;margin-bottom:30px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}.header h1{font-size:28px;margin-bottom:10px}.header p{font-size:16px;opacity:0.9}.section{background:white;padding:25px;margin-bottom:25px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);border:1px solid #eee}.section h2{color:#1e3c72;font-size:22px;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #eee}.table{width:100%;border-collapse:collapse;margin:20px 0}.table th,.table td{padding:12px;text-align:left;border:1px solid #ddd}.table th{background:#f8f9fa;font-weight:bold;color:#1e3c72}.table tr:nth-child(even){background:#f8f9fa}.chart-container{background:white;padding:20px;border-radius:8px;margin:20px 0}.chart-bar{height:30px;background:linear-gradient(90deg,#4CAF50 0%,#45a049 100%);margin:10px 0;border-radius:15px;position:relative}.chart-label{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:white;font-weight:bold}.status{display:inline-block;padding:5px 10px;border-radius:15px;font-size:14px;font-weight:bold}.status-completed{background:#d4edda;color:#155724}.status-pending{background:#fff3cd;color:#856404}.footer{text-align:center;padding:20px;margin-top:40px;border-top:2px solid #eee;color:#666;font-size:14px}</style></head><body><div class='header'><h1>Quarterly Performance Report</h1><p>Q4 2023 - Generated on January 15, 2024</p></div><div class='section'><h2>Executive Summary</h2><p>This report presents a comprehensive analysis of our Q4 2023 performance, highlighting key achievements, metrics, and areas for improvement.</p></div><div class='section'><h2>Key Performance Indicators</h2><div class='chart-container'><div class='chart-bar' style='width:85%'><span class='chart-label'>Revenue Growth: 85%</span></div><div class='chart-bar' style='width:92%'><span class='chart-label'>Customer Satisfaction: 92%</span></div><div class='chart-bar' style='width:78%'><span class='chart-label'>Employee Engagement: 78%</span></div></div></div><div class='section'><h2>Project Status Overview</h2><table class='table'><thead><tr><th>Project Name</th><th>Status</th><th>Completion</th><th>Budget Utilization</th></tr></thead><tbody><tr><td>Digital Transformation</td><td><span class='status status-completed'>Completed</span></td><td>100%</td><td>95%</td></tr><tr><td>Cloud Migration</td><td><span class='status status-pending'>In Progress</span></td><td>75%</td><td>80%</td></tr><tr><td>Security Enhancement</td><td><span class='status status-completed'>Completed</span></td><td>100%</td><td>88%</td></tr></tbody></table></div><div class='footer'><p>Confidential Document - For Internal Use Only</p><p>Generated by Performance Analytics System v2.0</p></div></body></html>","pdf_options":{"landscape":false,"scale":1.0,"paper_width":8.5,"paper_height":11.0,"margin_top":0.5,"margin_bottom":0.5,"margin_left":0.75,"margin_right":0.75,"print_background":true,"display_header_footer":false,"prefer_css_page_size":false}}"#;

    let input: Value = serde_json::from_str(test_input)?;

    let html = input["html"]
        .as_str()
        .ok_or_else(|| anyhow::anyhow!("Missing html in input"))?
        .to_string();
    let pdf_options = input["pdf_options"].clone();
    let pdf_options = if pdf_options.is_null() {
        None
    } else {
        Some(serde_json::from_value(pdf_options)?)
    };

    let renderer = PdfRenderer::new().await?;
    let pdf_bytes = renderer.render_pdf(html, pdf_options).await?;

    // Print the first few bytes and length
    println!(
        "PDF Bytes (first 20): {:?}",
        &pdf_bytes.iter().take(20).collect::<Vec<_>>()
    );
    println!("PDF total length: {} bytes", pdf_bytes.len());

    // Check if it starts with PDF magic number
    if pdf_bytes.starts_with(b"%PDF") {
        println!("Valid PDF magic number detected");
    } else {
        println!("WARNING: PDF magic number not found!");
        println!(
            "First 100 bytes as string: {}",
            String::from_utf8_lossy(&pdf_bytes[..100.min(pdf_bytes.len())])
        );
    }

    let output_dir = PathBuf::from("/tmp/output");
    fs::create_dir_all(&output_dir)?;

    let timestamp = Local::now().format("%Y%m%d_%H%M%S");
    let output_path = output_dir.join(format!("output_{}.pdf", timestamp));

    fs::write(&output_path, pdf_bytes)?;
    println!("PDF written to {}", output_path.display());

    Ok(())
}
