# SPDX-FileCopyrightText: 2023-2024 Sequent Tech <legal@sequentech.io>
#
# SPDX-License-Identifier: AGPL-3.0-only

FROM rust:1.90.0-slim-bookworm

WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    chromium \
    protobuf-compiler \
    libprotobuf-dev \
    m4 \
    make \
    pkg-config \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*


#TODO: Copy only necessary files
COPY ./braid/Cargo.toml ./braid/Cargo.toml
COPY ./b3/Cargo.toml ./b3/Cargo.toml
COPY ./electoral-log/Cargo.toml ./electoral-log/Cargo.toml
COPY ./harvest/Cargo.toml ./harvest/Cargo.toml
COPY ./strand/Cargo.toml ./strand/Cargo.toml
COPY ./immu-board/Cargo.toml ./immu-board/Cargo.toml
COPY ./immudb-rs/Cargo.toml ./immudb-rs/Cargo.toml
COPY ./sequent-core/Cargo.toml ./sequent-core/Cargo.toml
COPY ./velvet/Cargo.toml ./velvet/Cargo.toml
COPY ./windmill/Cargo.toml ./windmill/Cargo.toml
COPY ./e2e/Cargo.toml ./e2e/Cargo.toml
COPY ./e2e/src/mock_server/Cargo.toml ./e2e/src/mock_server/Cargo.toml
COPY ./step-cli/Cargo.toml ./step-cli/Cargo.toml
COPY ./wrap-map-err/Cargo.toml ./wrap-map-err/Cargo.toml
COPY ./braid/scripts/Cargo.toml ./braid/scripts/Cargo.toml
COPY ./orare/Cargo.toml ./orare/Cargo.toml
COPY ./orare/doc_renderer/Cargo.toml ./orare/doc_renderer/Cargo.toml
COPY ./Cargo.toml ./Cargo.toml
COPY ./Cargo.lock ./Cargo.lock
COPY ./.cargo ./.cargo
RUN mkdir -p ./harvest/src \
    && echo "// dummy file" > ./harvest/src/lib.rs
RUN mkdir -p ./immu-board/src \
    && echo "// dummy file" > ./immu-board/src/lib.rs
RUN mkdir -p ./immudb-rs/src \
    && echo "// dummy file" > ./immudb-rs/src/lib.rs
RUN mkdir -p ./windmill/src \
    && echo "// dummy file" > ./windmill/src/lib.rs
RUN mkdir -p ./e2e/src \
    && echo "// dummy file" > ./e2e/src/lib.rs
RUN mkdir -p ./e2e/src/mock_server/src \
    && echo "// dummy file" > ./e2e/src/mock_server/src/lib.rs
RUN mkdir -p ./velvet/src ./velvet/benches \
    && echo "// dummy file" > ./velvet/src/lib.rs \
    && echo "// dummy file" > ./velvet/benches/pdf_generation.rs
RUN mkdir -p ./strand/src \
    && echo "// dummy file" > ./strand/src/lib.rs
RUN mkdir -p ./strand/benches \
    && echo "// dummy file" > ./strand/benches/encrypt.rs \
    && echo "// dummy file" > ./strand/benches/shuffle.rs \
    && echo "// dummy file" > ./strand/benches/verify_ballot.rs
RUN mkdir -p ./b3/src \
    && echo "// dummy file" > ./b3/src/lib.rs
RUN mkdir -p ./electoral-log/src \
    && echo "// dummy file" > ./electoral-log/src/lib.rs
RUN mkdir -p ./sequent-core/src \
    mkdir -p ./sequent-core/examples \
    && echo "// dummy file" > ./sequent-core/src/lib.rs \
    && echo "// dummy file" > ./sequent-core/examples/render_pdf.rs
RUN mkdir -p ./wrap-map-err/src \
    && echo "// dummy file" > ./wrap-map-err/src/lib.rs
RUN mkdir -p ./braid/src \
    && echo "// dummy file" > ./braid/src/lib.rs
RUN mkdir -p ./orare/src \
    && echo "// dummy file" > ./orare/src/lib.rs
RUN mkdir -p ./orare/doc_renderer/src \
    && echo "// dummy file" > ./orare/doc_renderer/src/lib.rs

WORKDIR /app/harvest
RUN cargo fetch --locked
