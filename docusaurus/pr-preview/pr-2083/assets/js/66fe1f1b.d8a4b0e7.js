"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6404],{3619:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"developers/Tutorials/admin_portal_tutorials_setup_idp_initiated_sso","title":"Setup IDP Initiated SSO with SimpleSAMLphp as IDP and Keycloak as SP","description":"\x3c!--","source":"@site/docs/developers/10-Tutorials/03-admin_portal_tutorials_setup_idp_initiated_sso.md","sourceDirName":"developers/10-Tutorials","slug":"/developers/Tutorials/admin_portal_tutorials_setup_idp_initiated_sso","permalink":"/docusaurus/pr-preview/pr-2083/docs/developers/Tutorials/admin_portal_tutorials_setup_idp_initiated_sso","draft":false,"unlisted":false,"editUrl":"https://github.com/sequentech/step/docs/docusaurus/docs/developers/10-Tutorials/03-admin_portal_tutorials_setup_idp_initiated_sso.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"id":"admin_portal_tutorials_setup_idp_initiated_sso","title":"Setup IDP Initiated SSO with SimpleSAMLphp as IDP and Keycloak as SP"},"sidebar":"docs","previous":{"title":"Load Testing","permalink":"/docusaurus/pr-preview/pr-2083/docs/developers/Tutorials/Load-Testing/load_testing"},"next":{"title":"Reference Overview","permalink":"/docusaurus/pr-preview/pr-2083/docs/reference/reference"}}');var s=n(4848),r=n(8453);const l={id:"admin_portal_tutorials_setup_idp_initiated_sso",title:"Setup IDP Initiated SSO with SimpleSAMLphp as IDP and Keycloak as SP"},a=void 0,o={},d=[{value:"Overview",id:"overview",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"1: Configure SimpleSAMLphp (IdP)",id:"1-configure-simplesamlphp-idp",level:2},{value:"1.1. Enable IdP &amp; Unsolicited SSO",id:"11-enable-idp--unsolicited-sso",level:3},{value:"1.2. Define Authentication Source",id:"12-define-authentication-source",level:3},{value:"1.3. Configure IdP Metadata (Hosted)",id:"13-configure-idp-metadata-hosted",level:3},{value:"1.4. Configure SP Metadata (Remote)",id:"14-configure-sp-metadata-remote",level:3},{value:"2: Configure Keycloak (SP/Broker &amp; IdP for vp-sso)",id:"2-configure-keycloak-spbroker--idp-for-vp-sso",level:2},{value:"2.1. Configure Keycloak to Trust SimpleSAMLphp (Identity Provider)",id:"21-configure-keycloak-to-trust-simplesamlphp-identity-provider",level:3},{value:"2.2. Configure the vp-sso Client",id:"22-configure-the-vp-sso-client",level:3},{value:"Part 3: Create the IdP-Initiated SSO Trigger Page",id:"part-3-create-the-idp-initiated-sso-trigger-page",level:2},{value:"Part 4: Test the Flow",id:"part-4-test-the-flow",level:2},{value:"Part 5: Troubleshooting",id:"part-5-troubleshooting",level:2}];function c(e){const i={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(i.p,{children:"This tutorial explains how to set up IdP-initiated Single Sign-On (SSO). In this scenario:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Identity Provider (IdP):"})," SimpleSAMLphp handles user authentication."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Service Provider (SP) / Broker:"})," Keycloak acts as an SP, trusting SimpleSAMLphp for authentication. It also acts as an Identity Broker."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsxs)(i.strong,{children:["Target Client (",(0,s.jsx)(i.code,{children:"vp-sso"}),"):"]})," A specific SAML client ",(0,s.jsx)(i.em,{children:"within"})," Keycloak that itself acts as an SP, potentially relying on Keycloak (now acting as an IdP for it) after brokering the authentication from SimpleSAMLphp."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Flow:"})," The user starts at a special page hosted by SimpleSAMLphp, authenticates there, and is then redirected through Keycloak to a final target application (defined by the ",(0,s.jsx)(i.code,{children:"vp-sso"})," client's configuration or RelayState)."]}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"SimpleSAMLphp Instance:"})," Running and accessible (e.g., via Docker at ",(0,s.jsx)(i.code,{children:"http://localhost:8083/simplesaml/"}),"). Ensure PHP dependencies are installed and required modules (",(0,s.jsx)(i.code,{children:"saml"}),", ",(0,s.jsx)(i.code,{children:"exampleauth"}),", etc.) are enabled."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Keycloak Instance:"})," Running and accessible (e.g., at ",(0,s.jsx)(i.code,{children:"http://127.0.0.1:8090/"}),"). The realm should be configured as per your initial export."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Certificates:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["SimpleSAMLphp needs a private key (",(0,s.jsx)(i.code,{children:"server.pem"}),") and public certificate (",(0,s.jsx)(i.code,{children:"server.crt"}),") for signing SAML messages. Place these in the ",(0,s.jsx)(i.code,{children:"cert/"})," directory configured in SimpleSAMLphp."]}),"\n",(0,s.jsx)(i.li,{children:"Keycloak needs its own realm keys (usually auto-generated)."}),"\n",(0,s.jsx)(i.li,{children:"You'll need the public certificates of each system to configure trust in the other."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Networking:"})," Ensure Keycloak and SimpleSAMLphp can reach each other's endpoints via HTTP/HTTPS as needed. We'll primarily use HTTP POST binding."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Keycloak Custom Provider (Optional but in your config):"})," The ",(0,s.jsx)(i.code,{children:"SamlRedirectProvider"})," Java code needs to be compiled and deployed to Keycloak's ",(0,s.jsx)(i.code,{children:"providers/"})," directory if you intend to use the custom ",(0,s.jsx)(i.code,{children:"/redirect-provider/redirect"})," endpoint."]}),"\n"]}),"\n",(0,s.jsx)(i.hr,{}),"\n",(0,s.jsx)(i.h2,{id:"1-configure-simplesamlphp-idp",children:"1: Configure SimpleSAMLphp (IdP)"}),"\n",(0,s.jsx)(i.p,{children:"Configure SimpleSAMLphp to act as the central IdP."}),"\n",(0,s.jsx)(i.h3,{id:"11-enable-idp--unsolicited-sso",children:"1.1. Enable IdP & Unsolicited SSO"}),"\n",(0,s.jsxs)(i.p,{children:["Edit your SimpleSAMLphp configuration (",(0,s.jsx)(i.code,{children:"config/config.php"}),")"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-php",children:"<?php\n// File: /var/simplesamlphp/config/config.php\n\n// *** Crucial SAML IdP Settings ***\nenable.saml20-idp = true;       // Enable the SAML 2.0 IdP functionality\nsaml20.idp.allowunsolicited true; // IMPORTANT: Allow IdP-initiated flow\n\n// Session/State Storage (Memcache recommended for Docker, ensure memcached is running)\nstore.type = 'memcache';\n\n// Enable required modules (for the example)\nmodule.enable['exampleauth'] = true;\n\n// Security: Use HTTPS in production\nsession.cookie.secure = true; // Enable if using HTTPS\n\n"})}),"\n",(0,s.jsx)(i.h3,{id:"12-define-authentication-source",children:"1.2. Define Authentication Source"}),"\n",(0,s.jsx)(i.p,{children:"Configure how SimpleSAMLphp authenticates users. We'll use the example static user/password source."}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-php",children:"\n<?php  \n// File: /var/simplesamlphp/config/authsources.php\n\n$config = [  \n    'admin' => [  \n        'core:AdminPassword',  \n    ],\n\n    'example-userpass' => [  \n        'exampleauth:UserPass',\n\n        // Define test users and their attributes  \n        'student:studentpass' => [  \n             'uid' => ['student'],  \n             'eduPersonAffiliation' => ['member', 'student'],  \n             'email' => 'student@example.com', // **Keycloak will use this**  \n             'givenName' => 'Student',  \n             'sn' => 'User',  \n        ],  \n        'employee:employeepass' => [  \n             'uid' => ['employee'],  \n             'eduPersonAffiliation' => ['member', 'employee'],  \n             'email' => 'employee@example.com', // **Keycloak will use this**  \n             'givenName' => 'Employee',  \n             'sn' => 'User',  \n        ],  \n    ],  \n];\n"})}),"\n",(0,s.jsxs)(i.p,{children:[(0,s.jsx)(i.strong,{children:"Note:"})," Ensure attributes required by Keycloak (like email for the Principal Attribute) are defined for your test users."]}),"\n",(0,s.jsx)(i.h3,{id:"13-configure-idp-metadata-hosted",children:"1.3. Configure IdP Metadata (Hosted)"}),"\n",(0,s.jsx)(i.p,{children:"Define SimpleSAMLphp's own metadata as an IdP."}),"\n",(0,s.jsx)(i.p,{children:"PHP"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-php",children:"<?php  \n// File: /var/simplesamlphp/metadata/saml20-idp-hosted.php\n\n$metadata['http://localhost:8083/simplesaml/saml2/idp/metadata.php'] = [  \n    // The 'host' identifies the virtual host for this IdP configuration.  \n    'host' => '__DEFAULT__', // Use for the default virtual host\n\n    // Signing key and certificate (relative to the 'cert' directory)  \n    'privatekey' => 'server.pem',  // Your IdP's private signing key  \n    'certificate' => 'server.crt', // Your IdP's public certificate\n\n    // The authentication source SimpleSAMLphp will use for users logging in via this IdP  \n    'auth' => 'example-userpass', // Must match an ID in authsources.php\n\n    // --- Recommended Security Settings ---  \n    'sign.logout' => true,             // Sign logout requests/responses initiated by this IdP  \n    'saml20.sign.response' => true,    // Sign the entire SAML Response message  \n    'saml20.sign.assertion' => true,   // Sign the SAML Assertion within the Response\n\n    // --- Optional Settings ---  \n    // 'SingleSignOnServiceBinding' => ['urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect', 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST'], // Specify supported bindings  \n    // 'SingleLogoutServiceBinding' => ['urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect', 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST'],  \n];\n"})}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["The array key (",(0,s.jsx)(i.a,{href:"http://localhost:8083/",children:"http://localhost:8083/"}),"...) is the ",(0,s.jsx)(i.strong,{children:"Entity ID"})," of your SimpleSAMLphp IdP. Keycloak will need this."]}),"\n",(0,s.jsx)(i.li,{children:"Make sure privatekey and certificate point to valid files in your cert/ directory."}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"14-configure-sp-metadata-remote",children:"1.4. Configure SP Metadata (Remote)"}),"\n",(0,s.jsx)(i.p,{children:"Tell SimpleSAMLphp about the Keycloak instance (acting as SP/Broker) it trusts."}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-php",children:"\n<?php  \n// File: /var/simplesamlphp/metadata/saml20-sp-remote.php\n\n// Use the Keycloak Realm's SAML Entity ID as the key.  \n// Find this in Keycloak: Realm Settings -> General -> Endpoints -> SAML 2.0 Identity Provider Metadata -> entityID attribute  \n$metadata['tenant-e8062b49-532b-4f60-8548-0d3c14a25894-event-cd1397d3-d236-42b4-a019-49143b616e13'] = [\n    'AssertionConsumerService' => [\n        [\n            'Binding' => 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST',\n            'Location' => 'http://127.0.0.1:8090/realms/tenant-90505c8a-23a9-4cdf-a26b-4e19f6a097d5-event-cd1397d3-d236-42b4-a019-49143b616e13/broker/simplesamlphp/endpoint/clients/vp-sso',\n        ],\n    ],\n    'SingleLogoutService' => [\n        [\n            'Binding' => 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST',\n            'Location' => 'http://127.0.0.1:8090/realms/tenant-90505c8a-23a9-4cdf-a26b-4e19f6a097d5-event-cd1397d3-d236-42b4-a019-49143b616e13/broker/simplesamlphp/endpoint',\n        ],\n    ],\n\n    // Keycloak's Public Certificate (for validating signatures FROM Keycloak, e.g., signed AuthnRequests)  \n    // Get this from Keycloak: Realm Settings -> Keys -> RS256 -> Public key -> Certificate (copy the content)  \n    'certData' => 'MIIDOzCCAiMCBgGZ3f8D1TANBgkqhkiG9w0BAQsFADBhMV8wXQYDVQQDDFZ0ZW5hbnQtOTA1MDVjOGEtMjNhOS00Y2RmLWEyNmItNGUxOWY2YTA5N2Q1LWV2ZW50LTM3ZWI1MWE3LWM2YjktNDU2Zi05M2I0LTViZDA1MDgxYjE4ZjAeFw0yNTEwMTMxNDMzMjFaFw0zNTEwMTMxNDM1MDFaMGExXzBdBgNVBAMMVnRlbmFudC05MDUwNWM4YS0yM2E5LTRjZGYtYTI2Yi00ZTE5ZjZhMDk3ZDUtZXZlbnQtMzdlYjUxYTctYzZiOS00NTZmLTkzYjQtNWJkMDUwODFiMThmMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1vdrir39ABcm6tIVuy9Y+G4sPtrz3Rg2KtCFYPlf+7cBBb8L75SCheZVEtPVZ7djv6g7GjksNeeUjMQiNfPNlI9PGCd1Eeei0WnZ7FGOvQoFWv7SWqeCzu8tZJtBRqeWnuK8zLeka/amgdoygZ0gR3bqA/hI3EpNlPExZQNGITsWDsYZ/SKEIIkq37kXV/yTsW8h6jnJMydqgkN0MESErFiVIjGwrAvC7kA+7HLj0sOCNOaHu2U6LhZznfJuJBipCLfMbtjConOsXZC5GmMsJD7txPpejXfb82kmSHJcvsq3GFqF616mrW3rh2iM/gso3ClLeHpzwUG0weaKFbWyhwIDAQABMA0GCSqGSIb3DQEBCwUAA4IBAQDUbmfepXwr3aWHs/8UpIANLZqGN95+BSfuYi82gI+x0fKaxT+a7Sy2Om0juh77E+01B5lzdR2R72/39r/+1PGTpLdoQwVP9kFaDMuMNdYCZ4XS0HAeETuMPTAZVAqxiUc09ey0uKOJbpdWA8X0SDN8igwpIJGW2PSMo9A7rbkmOPFEF71je793TguCMqNbVGdDHWiI0ySXZh3Pw/UPdYyRhoUgINNELMjBmS4Yv1+S4Lpqz9ZL39eCULN1VkD2GK7Fnh3rosrWNP6TTIWNkvUY2Fw6Ptc3sikouSJRAvBA4H2JFAT3LA5nD5kh2EQfbgxMlWNzan/KJIESqNyo5XxL',\n\n    'validate.authnrequest' => true, // SimpleSAMLphp should validate signed AuthnRequests from Keycloak  \n    'validate.logoutrequest' => true, // SimpleSAMLphp should validate signed LogoutRequests from Keycloak  \n];\n"})}),"\n",(0,s.jsx)(i.hr,{}),"\n",(0,s.jsx)(i.h2,{id:"2-configure-keycloak-spbroker--idp-for-vp-sso",children:"2: Configure Keycloak (SP/Broker & IdP for vp-sso)"}),"\n",(0,s.jsx)(i.h3,{id:"21-configure-keycloak-to-trust-simplesamlphp-identity-provider",children:"2.1. Configure Keycloak to Trust SimpleSAMLphp (Identity Provider)"}),"\n",(0,s.jsx)(i.p,{children:"This configures Keycloak to act as an SP/Broker, using SimpleSAMLphp as an external IdP. Your initial realm export largely defines this."}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Navigate:"})," Go to Identity Providers in your Keycloak realm (tenant-...-event-...)."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Select/Verify simplesamlphp:"})," Create a provider with alias simplesamlphp (Provider ID saml)","\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Import Config:"})," Alternatively, you could import SimpleSAMLphp's metadata (",(0,s.jsx)(i.a,{href:"http://localhost:8083/simplesaml/saml2/idp/metadata.php",children:"http://localhost:8083/simplesaml/saml2/idp/metadata.php"}),")."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Key Settings:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["Single Sign-On Service URL: ",(0,s.jsx)(i.a,{href:"http://localhost:8083/simplesaml/saml2/idp/SSOService.php",children:"http://localhost:8083/simplesaml/saml2/idp/SSOService.php"})]}),"\n",(0,s.jsxs)(i.li,{children:["Single Logout Service URL: ",(0,s.jsx)(i.a,{href:"http://localhost:8083/simplesaml/saml2/idp/SingleLogoutService.php",children:"http://localhost:8083/simplesaml/saml2/idp/SingleLogoutService.php"})]}),"\n",(0,s.jsx)(i.li,{children:"NameID Policy Format: Transient (matches SimpleSAMLphp config)"}),"\n",(0,s.jsx)(i.li,{children:"Principal Type: Attribute Name"}),"\n",(0,s.jsx)(i.li,{children:"Principal Attribute: email"}),"\n",(0,s.jsxs)(i.li,{children:["HTTP-POST Binding Response: ",(0,s.jsx)(i.strong,{children:"ON"})]}),"\n",(0,s.jsxs)(i.li,{children:["HTTP-POST Binding AuthnRequest: ",(0,s.jsx)(i.strong,{children:"ON"})]}),"\n",(0,s.jsxs)(i.li,{children:["Want AuthnRequests Signed: ",(0,s.jsx)(i.strong,{children:"ON"})," (Keycloak will sign requests ",(0,s.jsx)(i.em,{children:"to"})," SimpleSAMLphp)"]}),"\n",(0,s.jsx)(i.li,{children:"Signature Algorithm: RSA_SHA256"}),"\n",(0,s.jsx)(i.li,{children:"SAML Signature Key Name: KEY_ID"}),"\n",(0,s.jsxs)(i.li,{children:["Want Assertions Signed: ",(0,s.jsx)(i.strong,{children:"ON"})," (SimpleSAMLphp signs assertions)"]}),"\n",(0,s.jsxs)(i.li,{children:["Validate Signatures: ",(0,s.jsx)(i.strong,{children:"ON"})]}),"\n",(0,s.jsxs)(i.li,{children:["Validating X509 Certificates: Paste the content of SimpleSAMLphp's server.crt (public certificate), ",(0,s.jsx)(i.em,{children:"without"})," the -----BEGIN... and -----END... lines."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Mapper:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"Go to the Mappers tab for simplesamlphp."}),"\n",(0,s.jsxs)(i.li,{children:["Create a mapper that maps a SAML attribute to a Keycloak user attribute. For the example we will create a mapper that maps the email.","\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"Name: email-mapper"}),"\n",(0,s.jsx)(i.li,{children:"Mapper type: Attribute Importer"}),"\n",(0,s.jsx)(i.li,{children:"Attribute Name: email"}),"\n",(0,s.jsx)(i.li,{children:"Friendly Name: Email"}),"\n",(0,s.jsx)(i.li,{children:"Name Format: Attribute_FORMAT_BASIC"}),"\n",(0,s.jsx)(i.li,{children:"User Attribute Name: email"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"22-configure-the-vp-sso-client",children:"2.2. Configure the vp-sso Client"}),"\n",(0,s.jsx)(i.p,{children:"This configures the specific vp-sso SAML client application."}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Navigate:"})," Go to Clients."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Create Client:"})," Click Create client."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"General Settings:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Client type:"})," SAML"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Client ID:"})," vp-sso"]}),"\n",(0,s.jsx)(i.li,{children:"Click Next."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Capability config:"})," Keep defaults, click Next."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Login settings:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Root URL:"})," ",(0,s.jsx)(i.a,{href:"http://localhost:3000",children:"http://localhost:3000"})]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Valid redirect URIs:"})," Add ",(0,s.jsx)(i.a,{href:"http://localhost:3000/",children:"http://localhost:3000/"}),"* (or be more specific if possible). The redirect-provider URL goes into the fine-grain settings."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"IdP-initiated SSO URL Name:"})," vp-sso"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"IdP-initiated SSO RelayState:"})," ",(0,s.jsx)(i.a,{href:"http://localhost:3000/tenant/90505c8a-23a9-4cdf-a26b-4e19f6a097d5/event/cd1397d3-d236-42b4-a019-49143b616e13/login",children:"http://localhost:3000/tenant/90505c8a-23a9-4cdf-a26b-4e19f6a097d5/event/cd1397d3-d236-42b4-a019-49143b616e13/login"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(i.li,{children:(0,s.jsx)(i.strong,{children:"Save."})}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Advanced Tab (Client Details):"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Fine grain SAML endpoint configuration:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Assertion Consumer Service POST Binding URL:"})," ",(0,s.jsx)(i.a,{href:"http://localhost:8090/realms/tenant-90505c8a-23a9-4cdf-a26b-4e19f6a097d5-event-cd1397d3-d236-42b4-a019-49143b616e13/redirect-provider/redirect",children:"http://localhost:8090/realms/tenant-90505c8a-23a9-4cdf-a26b-4e19f6a097d5-event-cd1397d3-d236-42b4-a019-49143b616e13/redirect-provider/redirect"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"SAML Capabilities:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Name ID format:"})," email"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Force POST binding:"})," ",(0,s.jsx)(i.strong,{children:"ON"})]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Force Name ID format:"})," ",(0,s.jsx)(i.strong,{children:"OFF"})]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Include AuthnStatement:"})," ",(0,s.jsx)(i.strong,{children:"ON"})]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Sign Documents:"})," ",(0,s.jsx)(i.strong,{children:"ON"})]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Sign Assertions:"})," ",(0,s.jsx)(i.strong,{children:"ON"})]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Signature Algorithm:"})," RSA_SHA256"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Signature and Encryption:"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Client signature required:"})," ",(0,s.jsx)(i.strong,{children:"ON"})]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Signing Certificate:"})," Click Import certificate, Format: X.509 Certificate PEM, paste the external SP's public signing certificate."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(i.hr,{}),"\n",(0,s.jsx)(i.h2,{id:"part-3-create-the-idp-initiated-sso-trigger-page",children:"Part 3: Create the IdP-Initiated SSO Trigger Page"}),"\n",(0,s.jsx)(i.p,{children:"Create a PHP page within SimpleSAMLphp's web-accessible directory to start the flow."}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-php",children:'\n<?php  \n// File: /var/simplesamlphp/public/idp-initiated-sso.php\n\n$simpleSamlBaseUrl = \'/simplesaml\'; // Path to simplesamlphp web root\n\n// Keycloak\'s Entity ID (as configured in saml20-sp-remote.php)  \n$keycloakSpEntityId = \'[http://127.0.0.1:8090/realms/tenant-90505c8a-23a9-4cdf-a26b-4e19f6a097d5-event-37eb51a7-c6b9-456f-93b4-5bd05081b18f](http://127.0.0.1:8090/realms/tenant-90505c8a-23a9-4cdf-a26b-4e19f6a097d5-event-37eb51a7-c6b9-456f-93b4-5bd05081b18f)\';\n\n// Final destination URL after successful authentication via Keycloak  \n$finalRedirectUrl = \'[http://127.0.0.1:3000/tenant/90505c8a-23a9-4cdf-a26b-4e19f6a097d5/event/37eb51a7-c6b9-456f-93b4-5bd05081b18f/login](http://127.0.0.1:3000/tenant/90505c8a-23a9-4cdf-a26b-4e19f6a097d5/event/37eb51a7-c6b9-456f-93b4-5bd05081b18f/login)\'; // Your target application URL\n\n// --- Construct the IdP-initiated SSO URL ---  \n$idpSsoUrl = "{$simpleSamlBaseUrl}/saml2/idp/SSOService.php";\n\n$queryParams = [  \n    \'spentityid\' => $keycloakSpEntityId, // Tell IdP which SP to send assertion to  \n    \'RelayState\' => $finalRedirectUrl, // Tell SP where to redirect user finally  \n];\n\n$loginUrl = $idpSsoUrl . \'?\' . http_build_query($queryParams);  \n?>\n\n<!DOCTYPE html>  \n<html lang="en">  \n<head>  \n    <meta charset="UTF-8">  \n    <meta name="viewport" content="width=device-width, initial-scale=1.0">  \n    <title>IdP Login Trigger</title>  \n    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"><\/script>  \n    <style> body { font-family: \'Inter\', sans-serif; } </style>  \n</head>  \n<body class="bg-gray-100 flex items-center justify-center h-screen">  \n    <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-8 text-center">  \n        <div class="mb-6">  \n            \x3c!-- Icon/Logo --\x3e  \n            <div class="mx-auto flex items-center justify-center h-16 w-16 bg-blue-100 rounded-full">  \n                <svg class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>  \n            </div>  \n            <h1 class="text-2xl font-bold text-gray-800 mt-4">IdP Login Page</h1>  \n            <p class="text-gray-600 mt-2">Start your Single Sign-On journey here.</p>  \n        </div>  \n        <div class="bg-gray-50 p-6 rounded-lg">  \n            <p class="text-gray-700 mb-4">Click below to log in via the central IdP.</p>  \n            <a href="<?php echo htmlspecialchars($loginUrl); ?>" class="w-full inline-block bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out">  \n                Login via SimpleSAMLphp IdP  \n            </a>  \n        </div>  \n        <p class="text-xs text-gray-400 mt-6">You will be redirected to authenticate.</p>  \n    </div>  \n</body>  \n</html>\n\n'})}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"Save this file in /var/simplesamlphp/public/ (or your equivalent public web directory for SimpleSAMLphp)."}),"\n",(0,s.jsxs)(i.li,{children:["Access it via your browser, e.g., ",(0,s.jsx)(i.a,{href:"http://localhost:8083/simplesaml/idp-initiated-sso.php",children:"http://localhost:8083/simplesaml/idp-initiated-sso.php"}),"."]}),"\n"]}),"\n",(0,s.jsx)(i.hr,{}),"\n",(0,s.jsx)(i.h2,{id:"part-4-test-the-flow",children:"Part 4: Test the Flow"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Open Browser:"})," Navigate to the trigger page: ",(0,s.jsx)(i.a,{href:"http://localhost:8083/simplesaml/idp-initiated-sso.php",children:"http://localhost:8083/simplesaml/idp-initiated-sso.php"}),"."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Click Login Button:"}),' Click the "Login via SimpleSAMLphp IdP" link.']}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"SimpleSAMLphp Authentication:"})," You should be redirected to the SimpleSAMLphp login page (e.g., example-userpass form). Enter valid credentials (e.g., student/studentpass)."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Redirection to Keycloak:"})," Upon successful authentication, SimpleSAMLphp generates a SAML assertion and POSTs it to Keycloak's broker endpoint (.../broker/simplesamlphp/endpoint), including the RelayState."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Keycloak Processing:"})," Keycloak validates the assertion, finds or creates the user based on the email attribute, and establishes a Keycloak session."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Final Redirection:"})," Keycloak should then redirect your browser to the URL specified in the RelayState (",(0,s.jsx)(i.a,{href:"http://127.0.0.1:3000/.../login",children:"http://127.0.0.1:3000/.../login"}),"). If your custom redirect-provider is involved, Keycloak might redirect to that endpoint first, which then performs the final redirect based on the RelayState it receives."]}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:"You should now be logged into your target application, having authenticated only at SimpleSAMLphp."}),"\n",(0,s.jsx)(i.hr,{}),"\n",(0,s.jsx)(i.h2,{id:"part-5-troubleshooting",children:"Part 5: Troubleshooting"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Check Logs:"})," Examine both SimpleSAMLphp logs (location depends on logging.handler) and Keycloak logs (server log) for detailed error messages. Increase log levels if necessary."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"SAML Tracer:"})," Use browser extensions (like SAML-tracer for Firefox, SAML Chrome Panel) to inspect the SAML messages being exchanged. Check for signature errors, incorrect destinations, missing attributes, or status code errors."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Metadata:"})," Ensure Entity IDs, ACS URLs, SLO URLs, and certificates match ",(0,s.jsx)(i.em,{children:"exactly"})," between SimpleSAMLphp's SP metadata (saml20-sp-remote.php) and Keycloak's IdP configuration."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Certificates:"})," Verify that the correct public certificates are used for signature validation in both systems. Ensure private keys are correctly configured and accessible. Check for expiration."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Clock Skew:"})," Make sure the servers running SimpleSAMLphp and Keycloak have synchronized clocks (using NTP is recommended)."]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"RelayState Issues:"})," If the final redirection fails:","\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"Verify the RelayState parameter is correctly included in the initial URL and subsequent SAML responses (use a tracer)."}),"\n",(0,s.jsx)(i.li,{children:"Check Keycloak's broker settings and logs to see how it handles RelayState."}),"\n",(0,s.jsx)(i.li,{children:"If using the custom SamlRedirectProvider, ensure it's deployed, check its specific logs, and verify the ACS URL in SimpleSAMLphp is pointing correctly if needed."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Session Storage:"}),' If you see "state not found" errors, ensure SimpleSAMLphp\'s store.type is configured correctly (e.g., memcache is running and accessible if configured).']}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Attribute Mapping:"})," If login succeeds but user details are missing in the target app, verify that SimpleSAMLphp includes the necessary attributes in the assertion (authsources.php) and that Keycloak's IdP mapper (email-mapper) and potentially client mappers (vp-sso client) are correctly configured."]}),"\n"]})]})}function h(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,i,n)=>{n.d(i,{R:()=>l,x:()=>a});var t=n(6540);const s={},r=t.createContext(s);function l(e){const i=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function a(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),t.createElement(r.Provider,{value:i},e.children)}}}]);