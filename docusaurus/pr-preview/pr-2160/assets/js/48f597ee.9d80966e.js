"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3846],{1319:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/simplesamlphp_admin_login-00740d654d29485e7477c6869facdcb7.png"},2112:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>a,frontMatter:()=>t,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"developers/Tutorials/setup_idp_initiated_sso","title":"IdP SSO Configuration & Handoff","description":"\x3c!--","source":"@site/docs/developers/10-Tutorials/03-setup_idp_initiated_sso.md","sourceDirName":"developers/10-Tutorials","slug":"/developers/Tutorials/setup_idp_initiated_sso","permalink":"/docusaurus/pr-preview/pr-2160/docs/developers/Tutorials/setup_idp_initiated_sso","draft":false,"unlisted":false,"editUrl":"https://github.com/sequentech/step/edit/main/docs/docusaurus/docs/developers/10-Tutorials/03-setup_idp_initiated_sso.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"id":"setup_idp_initiated_sso","title":"IdP SSO Configuration & Handoff"},"sidebar":"docs","previous":{"title":"Add a New Language","permalink":"/docusaurus/pr-preview/pr-2160/docs/developers/Tutorials/add_new_language"},"next":{"title":"Generating Dependency Report","permalink":"/docusaurus/pr-preview/pr-2160/docs/developers/Updates/generating-dependency-report"}}');var r=i(4848),l=i(8453);const t={id:"setup_idp_initiated_sso",title:"IdP SSO Configuration & Handoff"},d=void 0,c={},o=[{value:"Overview",id:"overview",level:2},{value:"What This Guide Covers",id:"what-this-guide-covers",level:3},{value:"Architecture Overview",id:"architecture-overview",level:3},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Phase 1: Initial Keycloak Configuration",id:"phase-1-initial-keycloak-configuration",level:2},{value:"Step 1.1: Create or Verify the Realm",id:"step-11-create-or-verify-the-realm",level:3},{value:"Step 1.2: Configure the vp-sso SAML Client",id:"step-12-configure-the-vp-sso-saml-client",level:3},{value:"Step 1.3: Prepare Configuration for Client",id:"step-13-prepare-configuration-for-client",level:3},{value:"Phase 2: Test with SimpleSAMLphp Reference Implementation",id:"phase-2-test-with-simplesamlphp-reference-implementation",level:2},{value:"Step 2.1: Set Up SimpleSAMLphp Locally",id:"step-21-set-up-simplesamlphp-locally",level:3},{value:"Step 2.2: Configure Keycloak to Trust SimpleSAMLphp",id:"step-22-configure-keycloak-to-trust-simplesamlphp",level:3},{value:"Step 2.3: (Optional) Enable Auto-Redirect to IdP",id:"step-23-optional-enable-auto-redirect-to-idp",level:3},{value:"Step 2.4: Run End-to-End Test",id:"step-24-run-end-to-end-test",level:3},{value:"Step 2.5: Troubleshooting Test Issues",id:"step-25-troubleshooting-test-issues",level:3},{value:"Phase 3: Client Handoff",id:"phase-3-client-handoff",level:2},{value:"Step 3.1: Information Package for Client",id:"step-31-information-package-for-client",level:3},{value:"Step 3.2: Request from Client",id:"step-32-request-from-client",level:3},{value:"Step 3.3: Configure Keycloak with Client IdP",id:"step-33-configure-keycloak-with-client-idp",level:3},{value:"Step 3.4: Production Handoff Checklist",id:"step-34-production-handoff-checklist",level:3},{value:"Phase 4: Post-Handoff Support",id:"phase-4-post-handoff-support",level:2},{value:"Common Client Issues",id:"common-client-issues",level:3},{value:"Issue 1: &quot;SAML Response Signature Invalid&quot;",id:"issue-1-saml-response-signature-invalid",level:4},{value:"Issue 2: &quot;Invalid Audience Restriction&quot;",id:"issue-2-invalid-audience-restriction",level:4},{value:"Issue 3: &quot;User Not Created / Email Missing&quot;",id:"issue-3-user-not-created--email-missing",level:4},{value:"Issue 4: &quot;RelayState Not Working&quot;",id:"issue-4-relaystate-not-working",level:4},{value:"Issue 5: &quot;SimpleSAMLphp trigger page not reachable in dev ENV&quot;",id:"issue-5-simplesamlphp-trigger-page-not-reachable-in-dev-env",level:4},{value:"Debugging Tools",id:"debugging-tools",level:3},{value:"Escalation Path",id:"escalation-path",level:3},{value:"Reference: Key URLs and Patterns",id:"reference-key-urls-and-patterns",level:2},{value:"Keycloak URLs",id:"keycloak-urls",level:3},{value:"Voting Portal URLs",id:"voting-portal-urls",level:3},{value:"SimpleSAMLphp Reference Files",id:"simplesamlphp-reference-files",level:3},{value:"Additional Resources",id:"additional-resources",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",hr:"hr",img:"img",input:"input",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(n.p,{children:["This guide is for ",(0,r.jsx)(n.strong,{children:"Sequent delivery team members"})," responsible for:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Configuring the Keycloak Service Provider (SP) for IdP-initiated SSO integrations"}),"\n",(0,r.jsx)(n.li,{children:"Testing the integration before client handoff"}),"\n",(0,r.jsx)(n.li,{children:"Handing off the integration to third-party clients"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Audience:"})," Sequent operations, delivery, and support teams"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"For third-party integrators:"})," See the ",(0,r.jsx)(n.a,{href:"../../integrations/idp_initiated_sso_integration_guide",children:"IdP-Initiated SSO Integration Guide"})," instead."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"For internal developers:"})," See the ",(0,r.jsx)(n.a,{href:"../Keycloak/idp_initiated_sso_design_implementation",children:"IdP-Initiated SSO Design & Implementation"})," for technical details."]}),"\n",(0,r.jsx)(n.h3,{id:"what-this-guide-covers",children:"What This Guide Covers"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Keycloak SP configuration"})," for a new tenant/event"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Testing with the SimpleSAMLphp reference implementation"})," before client handoff"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Information package"})," to provide to third-party integrators"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Handoff checklist"})," to ensure smooth client integration"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Troubleshooting"})," common issues during integration"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"architecture-overview",children:"Architecture Overview"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Third-Party IdP:"})," Client's identity provider (they control this)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Keycloak (SP/Broker):"})," Sequent-controlled authentication service that receives SAML assertions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Voting Portal:"})," Target application where users access voting functionality"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"SimpleSAMLphp Reference:"})," Testing tool to verify Keycloak configuration before client integration"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsx)(n.p,{children:"Before starting a new IdP-initiated SSO integration:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Tenant and Event Information:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Tenant ID (UUID)"}),"\n",(0,r.jsx)(n.li,{children:"Event ID (UUID)"}),"\n",(0,r.jsx)(n.li,{children:"Client organization name (for IdP alias)"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Access to Keycloak Admin Console:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Admin credentials for the Keycloak instance"}),"\n",(0,r.jsx)(n.li,{children:"Ability to create/modify realms, identity providers, and clients"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"For Testing (Optional but Recommended):"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Local SimpleSAMLphp instance for pre-handoff testing"}),"\n",(0,r.jsxs)(n.li,{children:["Access to the Step repository (",(0,r.jsx)(n.code,{children:".devcontainer/simplesamlphp/"}),")"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Client Information (to be received from third-party):"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"IdP Entity ID"}),"\n",(0,r.jsx)(n.li,{children:"IdP SSO Service URL"}),"\n",(0,r.jsx)(n.li,{children:"IdP public signing certificate (X.509 format)"}),"\n",(0,r.jsx)(n.li,{children:"IdP metadata URL (if available)"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"phase-1-initial-keycloak-configuration",children:"Phase 1: Initial Keycloak Configuration"}),"\n",(0,r.jsx)(n.h3,{id:"step-11-create-or-verify-the-realm",children:"Step 1.1: Create or Verify the Realm"}),"\n",(0,r.jsx)(n.p,{children:"The realm identifier follows the pattern:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"tenant-{TENANT_ID}-event-{EVENT_ID}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"tenant-90505c8a-23a9-4cdf-a26b-4e19f6a097d5-event-cd1397d3-d236-42b4-a019-49143b616e13\n"})}),"\n",(0,r.jsx)(n.p,{children:"Typically, this is created automatically for every Election Event. For example,\nwhen you import or create an election event, the url of the election event\ncontains the election event id, something like:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"http://localhost:3002/sequent_backend_election_event/e3329c90-a238-4e45-b480-18a8b5ad64cf\n"})}),"\n",(0,r.jsxs)(n.p,{children:["And also the realm identifier appear in the login link for the election event,\nthat you can obtain at the bottom of the Admin Portal Dashboard under the Link\n",(0,r.jsx)(n.code,{children:"Voter Login URL"}),", something like:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"http://localhost:3000/tenant/90505c8a-23a9-4cdf-a26b-4e19f6a097d5/event/e3329c90-a238-4e45-b480-18a8b5ad64cf/login\n"})}),"\n",(0,r.jsx)(n.p,{children:"Once you have obtained the realm identifier:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Log into Keycloak Admin Console"}),"\n",(0,r.jsxs)(n.li,{children:["Find the realm in the sidebar under ",(0,r.jsx)(n.code,{children:"Manage Realms"})," action"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"To export the realm certificate:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Go to ",(0,r.jsx)(n.strong,{children:"Realm Settings"})," \u2192 ",(0,r.jsx)(n.strong,{children:"Keys"})," tab"]}),"\n",(0,r.jsxs)(n.li,{children:["Find the ",(0,r.jsx)(n.code,{children:"RSA"})," key of use ",(0,r.jsx)(n.code,{children:"SIG"})]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Certificate"})," button"]}),"\n",(0,r.jsxs)(n.li,{children:["Copy the certificate (this will be provided to the client as ",(0,r.jsx)(n.code,{children:"SP_CERT_DATA"}),")"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-12-configure-the-vp-sso-saml-client",children:"Step 1.2: Configure the vp-sso SAML Client"}),"\n",(0,r.jsxs)(n.p,{children:["This client represents the voting portal application. The configuration below is\ntypically already automatically set up by the default keycloak realm\nconfiguration in Sequent Voting Plataform. However, you can also use the\ninstructions below to verify everything is correctly configured, or in case the\nrealm template is misconfigured or old, to configure these settings manually.\n",(0,r.jsx)(n.em,{children:"Note: The vp-sso client configuration that comes by default at election event creation might be wrong or outdated.\nIt is recommended to create a new configuration or follow this guide to review it."})]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Navigate:"})," Go to ",(0,r.jsx)(n.strong,{children:"Clients"})," in the realm"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Create Client:"})," Click ",(0,r.jsx)(n.strong,{children:"Create client"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"General Settings:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Client type:"})," SAML"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Client ID:"})," ",(0,r.jsx)(n.code,{children:"vp-sso"})]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Next"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Capability config:"})," Keep defaults, click ",(0,r.jsx)(n.strong,{children:"Next"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Login settings:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Root URL:"})," ",(0,r.jsx)(n.code,{children:"{VOTING_PORTAL_URL}"})," (e.g., ",(0,r.jsx)(n.code,{children:"https://voting-{subdomain}.sequentech.io"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Valid redirect URIs:"})," ",(0,r.jsx)(n.code,{children:"{VOTING_PORTAL_URL}/*"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"IdP-initiated SSO URL Name:"})," ",(0,r.jsx)(n.code,{children:"vp-sso"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"IdP-initiated SSO RelayState:"})," ",(0,r.jsx)(n.code,{children:"{VOTING_PORTAL_URL}/tenant/{TENANT_ID}/event/{EVENT_ID}/login"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"SAML Capabilities:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Name ID format:"})," ",(0,r.jsx)(n.code,{children:"email"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Force Name ID format:"})," ",(0,r.jsx)(n.strong,{children:"OFF"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Force POST binding:"})," ",(0,r.jsx)(n.strong,{children:"ON"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Include AuthnStatement:"})," ",(0,r.jsx)(n.strong,{children:"ON"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Signature and Encryption:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Sign Documents:"})," ",(0,r.jsx)(n.strong,{children:"ON"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Sign Assertions:"})," ",(0,r.jsx)(n.strong,{children:"ON"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Signature Algorithm:"})," ",(0,r.jsx)(n.code,{children:"RSA_SHA256"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Client signature required:"})," ",(0,r.jsx)(n.strong,{children:"OFF"})," (the voting portal doesn't sign requests). Ignore it if this option does not appear."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Click ",(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"Save"})})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:[(0,r.jsx)(n.code,{children:"Advanced"})," Tab:"]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Fine grain SAML endpoint configuration:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Assertion Consumer Service POST Binding URL:"})," ",(0,r.jsx)(n.code,{children:"{KEYCLOAK_BASE_URL}/realms/{REALM_ID}/redirect-provider/redirect"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Click ",(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"Save"})})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-13-prepare-configuration-for-client",children:"Step 1.3: Prepare Configuration for Client"}),"\n",(0,r.jsx)(n.p,{children:"At this point, you have the Keycloak configuration complete. Now prepare the information package for the client."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Configuration values to provide to client:"})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Parameter"}),(0,r.jsx)(n.th,{children:"Value"}),(0,r.jsx)(n.th,{children:"Example"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"TENANT_ID"})}),(0,r.jsx)(n.td,{children:"The tenant UUID"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"abc12345-6789-..."})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"EVENT_ID"})}),(0,r.jsx)(n.td,{children:"The event UUID"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"def67890-1234-..."})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"SP_BASE_URL"})}),(0,r.jsx)(n.td,{children:"Keycloak base URL"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"https://login-example.sequent.vote/auth/"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"SP_IDP_ALIAS"})}),(0,r.jsx)(n.td,{children:"IdP alias (decided with client)"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"clientname-idp"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"SP_CLIENT_ID"})}),(0,r.jsx)(n.td,{children:"SAML client ID"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"vp-sso"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"SP_CERT_DATA"})}),(0,r.jsx)(n.td,{children:"Keycloak realm certificate"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"MIIDOzCCAi..."})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"VOTING_PORTAL_URL"})}),(0,r.jsx)(n.td,{children:"Voting portal URL"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"https://voting-example.sequent.vote"})})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"phase-2-test-with-simplesamlphp-reference-implementation",children:"Phase 2: Test with SimpleSAMLphp Reference Implementation"}),"\n",(0,r.jsx)(n.p,{children:"Before handing off to the client, test the Keycloak configuration using the\nSimpleSAMLphp reference implementation."}),"\n",(0,r.jsx)(n.h3,{id:"step-21-set-up-simplesamlphp-locally",children:"Step 2.1: Set Up SimpleSAMLphp Locally"}),"\n",(0,r.jsxs)(n.p,{children:["If you are testing this in step repository devcontainer environment, then you\nneed to edit the environment configuration variables in the ",(0,r.jsx)(n.code,{children:".devcontainer/.env"}),"\nfile. Otherwise, you will have to replicate these variables used by the\n",(0,r.jsx)(n.code,{children:"simplesamlphp"})," sample app, which you can find in\n",(0,r.jsx)(n.code,{children:".devcontainer/simplesamlphp/.env.example"}),".\nIf you are in dev environment edit ",(0,r.jsx)(n.code,{children:".devcontainer/.env.development"})," and do not forget to run the vscode task ",(0,r.jsx)(n.code,{children:"update.env"})," afterwards. Last but not least: do not commit the changes."]}),"\n",(0,r.jsx)(n.p,{children:"We will asume you are using the step repository devcontainer environment."}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Edit ",(0,r.jsx)(n.code,{children:".devcontainer/.env"})," with your test configuration:"]})}),"\n",(0,r.jsxs)(n.p,{children:["Please ensure you use the data relative to your specific environment. For\nexample, ",(0,r.jsx)(n.code,{children:"SP_CERT_DATA"})," was obtained in point 1.1. You will be editing the\nsection titled ",(0,r.jsx)(n.code,{children:"SimpleSAMLphp IdP Configuration"})," that starts as it is shown\nbelow:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"################################################################################\n# SimpleSAMLphp IdP Configuration\n# These variables configure the SimpleSAMLphp instance as a reference IdP\n# implementation for third-party integrators.\n\n# =============================================================================\n# Simple SAML PHP General Configuration\n# =============================================================================\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Start SimpleSAMLphp"})," (using Docker or your preferred method). If you are\ntesting this with devcontainers, you can run in VSCode the task\n",(0,r.jsx)(n.code,{children:"logs.restart.simplesamlphp"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Login into SimpleSAMLphp application"}),", it should be an URL like\n",(0,r.jsx)(n.code,{children:"https://localhost:8083/simplesaml/module.php/admin"}),", in general something\nlike ",(0,r.jsx)(n.code,{children:"{IDP_BASE_URL}/module.php/admin"}),". You should get a login page as below:"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"admin"})," password is setup in the ",(0,r.jsx)(n.code,{children:".env"})," file mentioned earlier with the\nvariable ",(0,r.jsx)(n.code,{children:"SSP_ADMIN_PASSWORD"})," and it's ",(0,r.jsx)(n.code,{children:"admin"})," by default, but please remember\nthis is just a sample implementation, use secure passwords in production."]})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Admin Login",src:i(1319).A+"",width:"2312",height:"1658"})}),"\n",(0,r.jsx)(n.p,{children:"After login in the SimpleSAMLphp Admin Portal, you should see something like:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Admin Portal",src:i(8212).A+"",width:"2312",height:"1658"})}),"\n",(0,r.jsx)(n.h3,{id:"step-22-configure-keycloak-to-trust-simplesamlphp",children:"Step 2.2: Configure Keycloak to Trust SimpleSAMLphp"}),"\n",(0,r.jsx)(n.p,{children:"Now configure Keycloak to accept SAML assertions from your local SimpleSAMLphp instance."}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Navigate to Authentication"})," in your Keycloak realm"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"In the flows tab"})," Click ",(0,r.jsx)(n.strong,{children:"Create flow"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Name:"})," ",(0,r.jsx)(n.code,{children:"saml first broker flow"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Flow type:"})," Basic flow"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Create"})]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Add execution"})]}),"\n",(0,r.jsxs)(n.li,{children:["Search for ",(0,r.jsx)(n.code,{children:"Detect existing broker user"})," execution and then click ",(0,r.jsx)(n.strong,{children:"Add"})]}),"\n",(0,r.jsxs)(n.li,{children:["Set the execution to ",(0,r.jsx)(n.strong,{children:"Required"})]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Add execution"})]}),"\n",(0,r.jsxs)(n.li,{children:["Search for ",(0,r.jsx)(n.code,{children:"Automatically set existing user"})," execution and then click ",(0,r.jsx)(n.strong,{children:"Add"})]}),"\n",(0,r.jsxs)(n.li,{children:["Set the execution to ",(0,r.jsx)(n.strong,{children:"Required"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Navigate to Identity Providers"})," in your Keycloak realm"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Add provider:"})," Click ",(0,r.jsx)(n.strong,{children:"Add provider"})," \u2192 ",(0,r.jsx)(n.strong,{children:"SAML v2.0"})]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Configure Identity Provider:"})}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Alias:"})," ",(0,r.jsx)(n.code,{children:"yourcompany-idp"})," (matches ",(0,r.jsx)(n.code,{children:"SP_IDP_ALIAS"})," from ",(0,r.jsx)(n.code,{children:".env"}),")."]}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"It is not possible to edit the Alias if it already exists. If you need to change it, remove the existing Identity Provider and create a new one."})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Display Name:"})," ",(0,r.jsx)(n.code,{children:"SimpleSAMLphp IdP"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Service provider entity ID:"})," ",(0,r.jsx)(n.code,{children:"tenant-{TENANT_ID}-event-{EVENT_ID}"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Import SimpleSAMLphp metadata (recommended):"})}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use Entity Descriptor"}),": ",(0,r.jsx)(n.strong,{children:"OFF"})]}),"\n",(0,r.jsxs)(n.li,{children:["Download ",(0,r.jsx)(n.code,{children:"https://localhost:8083/simplesaml/saml2/idp/metadata.php"})]}),"\n",(0,r.jsxs)(n.li,{children:["Drag and drop the downloaded xml into ",(0,r.jsx)(n.strong,{children:"Import config from file"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Principal Type:"})," ",(0,r.jsx)(n.code,{children:"Attribute [Name]"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Principal Attribute:"})," ",(0,r.jsx)(n.code,{children:"email"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Validate Signatures:"})," ",(0,r.jsx)(n.strong,{children:"ON"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Want AuthnRequests signed:"})," ",(0,r.jsx)(n.strong,{children:"ON"})]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Add"})]}),"\n",(0,r.jsxs)(n.li,{children:["Then edit it and configure ",(0,r.jsx)(n.strong,{children:"First login flow override:"})," saml first broker\nflow."]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Save"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"OR manually configure:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use Entity Descriptor"}),": ",(0,r.jsx)(n.strong,{children:"OFF"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Single Sign-On Service URL:"})," ",(0,r.jsx)(n.code,{children:"https://localhost:8083/simplesaml/saml2/idp/SSOService.php"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Single Logout Service URL:"})," ",(0,r.jsx)(n.code,{children:"https://localhost:8083/simplesaml/saml2/idp/SingleLogoutService.php"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"NameID Policy Format:"})," Transient"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Principal Type:"})," Attribute Name"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Principal Attribute:"})," email"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"HTTP-POST Binding Response:"})," ",(0,r.jsx)(n.strong,{children:"ON"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"HTTP-POST Binding AuthnRequest:"})," ",(0,r.jsx)(n.strong,{children:"ON"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Want AuthnRequests Signed:"})," ",(0,r.jsx)(n.strong,{children:"ON"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Signature Algorithm:"})," RSA_SHA256"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Want Assertions Signed:"})," ",(0,r.jsx)(n.strong,{children:"ON"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Validate Signatures:"})," ",(0,r.jsx)(n.strong,{children:"ON"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Validating X509 Certificates:"})," Paste SimpleSAMLphp's public certificate (",(0,r.jsx)(n.code,{children:"server.crt"})," content, without BEGIN/END lines)"]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Add"})," and scroll to the bottom to find the ",(0,r.jsx)(n.code,{children:"First login flow override"})," setting."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"First login flow override:"})," saml first broker flow"]}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Configure Attribute Mapper:"})}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Go to ",(0,r.jsx)(n.strong,{children:"Mappers"})," tab"]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Create"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Name:"})," ",(0,r.jsx)(n.code,{children:"email-mapper"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mapper type:"})," Attribute Importer"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Attribute Name:"})," ",(0,r.jsx)(n.code,{children:"email"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Friendly Name:"})," Email"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Name Format:"})," ATTRIBUTE_FORMAT_BASIC"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"User Attribute Name:"})," ",(0,r.jsx)(n.code,{children:"email"})]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Save"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-23-optional-enable-auto-redirect-to-idp",children:"Step 2.3: (Optional) Enable Auto-Redirect to IdP"}),"\n",(0,r.jsx)(n.p,{children:"To skip the Keycloak login page and automatically redirect users to the external IdP:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Navigate to Authentication"})," \u2192 ",(0,r.jsx)(n.strong,{children:"Flows"})," in your Keycloak realm"]}),"\n",(0,r.jsxs)(n.li,{children:["Select ",(0,r.jsx)(n.strong,{children:"Browser"})," flow (or your custom browser flow if you have one)"]}),"\n",(0,r.jsxs)(n.li,{children:["Find the ",(0,r.jsx)(n.strong,{children:"Identity Provider Redirector"})," execution"]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Actions"})," \u2192 ",(0,r.jsx)(n.strong,{children:"Config"})]}),"\n",(0,r.jsxs)(n.li,{children:["Set ",(0,r.jsx)(n.strong,{children:"Alias:"})," ",(0,r.jsx)(n.code,{children:"auto-redirect-idp"})]}),"\n",(0,r.jsxs)(n.li,{children:["Set ",(0,r.jsx)(n.strong,{children:"Default Identity Provider:"})," ",(0,r.jsx)(n.code,{children:"yourcompany-idp"})," (must match your IdP alias exactly)"]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Save"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"What this does:"})," Users accessing the voting portal will be immediately redirected to the external IdP without seeing the Keycloak login page."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"When to use:"})," Enable this when all voters must authenticate through the external IdP and you don't need local Keycloak accounts."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Admin access:"})," You can still access Keycloak admin console directly at ",(0,r.jsx)(n.code,{children:"{KEYCLOAK_URL}/admin/{realm}/console"})]}),"\n",(0,r.jsx)(n.h3,{id:"step-24-run-end-to-end-test",children:"Step 2.4: Run End-to-End Test"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Access the SimpleSAMLphp trigger page:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"https://localhost:8083/simplesaml/idp-initiated-sso.php\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:'Click "Login to Voting Portal"'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Authenticate"})," with test credentials (as configured in ",(0,r.jsx)(n.code,{children:"SSP_EXAMPLE_USERS"})," env var):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Default: Username: ",(0,r.jsx)(n.code,{children:"user1"})," / Password: ",(0,r.jsx)(n.code,{children:"password"})]}),"\n",(0,r.jsxs)(n.li,{children:["Or: Username: ",(0,r.jsx)(n.code,{children:"user2"})," / Password: ",(0,r.jsx)(n.code,{children:"password"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["You can customize test users by editing the ",(0,r.jsx)(n.code,{children:"SSP_EXAMPLE_USERS"})," environment\nvariable in ",(0,r.jsx)(n.code,{children:".devcontainer/.env"}),". Format: ",(0,r.jsx)(n.code,{children:"username1:password1:email1,username2:password2:email2,..."})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Authenticated:"})," You should get authenticated succesfully and redirected\nto the voting portal. The intermiate steps that happens quickly one after\nthe other are:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"SimpleSAMLphp authenticates the user"}),"\n",(0,r.jsx)(n.li,{children:"SAML assertion is generated and POSTed to Keycloak"}),"\n",(0,r.jsx)(n.li,{children:"Keycloak validates the signature"}),"\n",(0,r.jsx)(n.li,{children:"Keycloak creates/updates user based on email attribute"}),"\n",(0,r.jsx)(n.li,{children:"Browser redirects to Voting Portal"}),"\n",(0,r.jsx)(n.li,{children:"Voting Portal detects user is authenticated and it lists available ballots"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-25-troubleshooting-test-issues",children:"Step 2.5: Troubleshooting Test Issues"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Issue: Login timeout. Please sign in again"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Verify ",(0,r.jsx)(n.code,{children:"EVENT_ID"})," and ",(0,r.jsx)(n.code,{children:"TENANT_ID"})," in ",(0,r.jsx)(n.code,{children:".env"})," are correct and that the Keycloak\nService provider entity ID is equal to the realm's name, something like\n",(0,r.jsx)(n.code,{children:"tenant-{TENANT_ID}-event-{EVENT_ID}"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:'Issue: "Identity Provider not found"'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Verify ",(0,r.jsx)(n.code,{children:"SP_IDP_ALIAS"})," in ",(0,r.jsx)(n.code,{children:".env"})," matches the Keycloak Identity Provider alias"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:'Issue: "Signature validation failed"'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Ensure SimpleSAMLphp's ",(0,r.jsx)(n.code,{children:"server.crt"})," certificate is correctly pasted in Keycloak"]}),"\n",(0,r.jsxs)(n.li,{children:["Remove ",(0,r.jsx)(n.code,{children:"-----BEGIN CERTIFICATE-----"})," and ",(0,r.jsx)(n.code,{children:"-----END CERTIFICATE-----"})," lines"]}),"\n",(0,r.jsxs)(n.li,{children:["Check that SimpleSAMLphp is signing assertions (check ",(0,r.jsx)(n.code,{children:"saml20-idp-hosted.php"}),")"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:'Issue: "User not created"'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Verify the ",(0,r.jsx)(n.code,{children:"email"})," attribute mapper is configured in Keycloak"]}),"\n",(0,r.jsxs)(n.li,{children:["Check SimpleSAMLphp's ",(0,r.jsx)(n.code,{children:"authsources.php"})," includes ",(0,r.jsx)(n.code,{children:"email"})," in user attributes"]}),"\n",(0,r.jsxs)(n.li,{children:["Verify the ",(0,r.jsx)(n.code,{children:"SSP_EXAMPLE_USERS"})," environment variable is correctly formatted with emails"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:'Issue: "Wrong redirect URL"'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Verify the ",(0,r.jsx)(n.code,{children:"RelayState"})," in SimpleSAMLphp's ",(0,r.jsx)(n.code,{children:"idp-initiated-sso.php"})]}),"\n",(0,r.jsx)(n.li,{children:"Check it matches the expected voting portal login URL pattern"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"phase-3-client-handoff",children:"Phase 3: Client Handoff"}),"\n",(0,r.jsx)(n.p,{children:"Once testing is successful, prepare the handoff package for the client."}),"\n",(0,r.jsx)(n.h3,{id:"step-31-information-package-for-client",children:"Step 3.1: Information Package for Client"}),"\n",(0,r.jsx)(n.p,{children:"Provide the client with:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Configuration Values (from Step 1.3)"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Integration Guide:"})," Link to ",(0,r.jsx)(n.code,{children:"/docs/integrations/idp_initiated_sso_integration_guide"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Reference Implementation:"})," Access to ",(0,r.jsx)(n.code,{children:".devcontainer/simplesamlphp/"})," in the Step repository"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Keycloak Metadata URL:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"{SP_BASE_URL}/realms/tenant-{TENANT_ID}-event-{EVENT_ID}/broker/{SP_IDP_ALIAS}/endpoint/descriptor\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-32-request-from-client",children:"Step 3.2: Request from Client"}),"\n",(0,r.jsx)(n.p,{children:"Request the following from the client:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"IdP Metadata URL"})," (preferred) or:"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Manual configuration values:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"IdP Entity ID"}),"\n",(0,r.jsx)(n.li,{children:"IdP SSO Service URL"}),"\n",(0,r.jsx)(n.li,{children:"IdP Single Logout Service URL (optional)"}),"\n",(0,r.jsx)(n.li,{children:"IdP public signing certificate (X.509 PEM format)"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test user credentials"})," for staging verification"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Expected production go-live date"})}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-33-configure-keycloak-with-client-idp",children:"Step 3.3: Configure Keycloak with Client IdP"}),"\n",(0,r.jsx)(n.p,{children:"Once you receive the client's IdP information:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Delete or disable the SimpleSAMLphp test Identity Provider"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Create new Identity Provider"})," for the client:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Alias:"})," ",(0,r.jsx)(n.code,{children:"{client-name}-idp"})," (use client organization name)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Import client's IdP metadata"})," (preferred) or manually configure"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Configure same attribute mappers"})," as in testing"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Enable signature validation"})," (",(0,r.jsx)(n.code,{children:"Validate Signatures: ON"}),")"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Paste client's public certificate"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Test with client:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Client initiates SSO from their IdP"}),"\n",(0,r.jsx)(n.li,{children:"Verify user attributes are correctly mapped"}),"\n",(0,r.jsx)(n.li,{children:"Verify redirect to voting portal works"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-34-production-handoff-checklist",children:"Step 3.4: Production Handoff Checklist"}),"\n",(0,r.jsx)(n.p,{children:"Before going live, verify:"}),"\n",(0,r.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Keycloak realm configuration complete"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Client's production IdP configured and trusted"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Production certificates exchanged"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Attribute mapping tested (email required)"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","End-to-end test successful in staging environment"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Production URLs configured (no localhost references)"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","HTTPS enabled on all endpoints"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Backup of Keycloak realm configuration taken"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Monitoring and logging enabled"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Client has integration guide documentation"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Go-live date coordinated with client"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"phase-4-post-handoff-support",children:"Phase 4: Post-Handoff Support"}),"\n",(0,r.jsx)(n.h3,{id:"common-client-issues",children:"Common Client Issues"}),"\n",(0,r.jsx)(n.h4,{id:"issue-1-saml-response-signature-invalid",children:'Issue 1: "SAML Response Signature Invalid"'}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Client Side:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Their IdP isn't signing the response/assertion"}),"\n",(0,r.jsx)(n.li,{children:"Wrong signing algorithm"}),"\n",(0,r.jsx)(n.li,{children:"Certificate mismatch"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Sequent Side:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Verify we have their correct public certificate in Keycloak"}),"\n",(0,r.jsxs)(n.li,{children:["Check ",(0,r.jsx)(n.code,{children:"Validate Signatures"})," is enabled"]}),"\n",(0,r.jsx)(n.li,{children:"Verify signing algorithm matches (RSA-SHA256 or stronger)"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Resolution:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Request updated certificate from client"}),"\n",(0,r.jsx)(n.li,{children:"Have client verify their IdP signing configuration"}),"\n",(0,r.jsx)(n.li,{children:"Use SAML tracer to inspect signature in assertion"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"issue-2-invalid-audience-restriction",children:'Issue 2: "Invalid Audience Restriction"'}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Cause:"})," Client's IdP is sending wrong audience value"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Resolution:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Client must set audience to: ",(0,r.jsx)(n.code,{children:"tenant-{TENANT_ID}-event-{EVENT_ID}"})]}),"\n",(0,r.jsxs)(n.li,{children:["Verify client has correct ",(0,r.jsx)(n.code,{children:"SP_REALM"})," value"]}),"\n",(0,r.jsx)(n.li,{children:"Reference the SimpleSAMLphp SP remote metadata configuration"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"issue-3-user-not-created--email-missing",children:'Issue 3: "User Not Created / Email Missing"'}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Cause:"})," Email attribute not included in SAML assertion"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Resolution:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Verify Keycloak attribute mapper configuration"}),"\n",(0,r.jsxs)(n.li,{children:["Have client check their IdP includes ",(0,r.jsx)(n.code,{children:"email"})," attribute"]}),"\n",(0,r.jsx)(n.li,{children:"Compare assertion structure with SimpleSAMLphp example"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"issue-4-relaystate-not-working",children:'Issue 4: "RelayState Not Working"'}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Cause:"})," RelayState not preserved through flow"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Resolution:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Verify client's IdP includes RelayState in SAML Response POST"}),"\n",(0,r.jsx)(n.li,{children:"Check client is using correct RelayState URL format"}),"\n",(0,r.jsx)(n.li,{children:"Test with SimpleSAMLphp to verify Keycloak side works"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"issue-5-simplesamlphp-trigger-page-not-reachable-in-dev-env",children:'Issue 5: "SimpleSAMLphp trigger page not reachable in dev ENV"'}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Cause:"})," Bad ports configuration"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Resolution:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Check PORTS tab in vscode to verify whether simplesamlphp service port is being forwarded"}),"\n",(0,r.jsx)(n.li,{children:"Add simplesamlphp:8083"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"debugging-tools",children:"Debugging Tools"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"SAML Tracer Browser Extension:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Firefox: SAML-tracer"}),"\n",(0,r.jsx)(n.li,{children:"Chrome: SAML Chrome Panel"}),"\n",(0,r.jsx)(n.li,{children:"Captures all SAML messages in flight"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Keycloak Logs:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Enable DEBUG level logging for SAML broker"}),"\n",(0,r.jsx)(n.li,{children:"Check for signature validation errors"}),"\n",(0,r.jsx)(n.li,{children:"Look for attribute mapping issues"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Client Comparison:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Compare client's SAML assertion with SimpleSAMLphp reference"}),"\n",(0,r.jsx)(n.li,{children:"Verify structure matches expected format"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"escalation-path",children:"Escalation Path"}),"\n",(0,r.jsx)(n.p,{children:"If issues persist:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Review with internal dev team"})," (reference design documentation)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Request SAML tracer logs"})," from client"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Compare assertions"})," side-by-side with working SimpleSAMLphp example"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Schedule debug session"})," with client technical team"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Check Keycloak version compatibility"})," if using newer SAML features"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"reference-key-urls-and-patterns",children:"Reference: Key URLs and Patterns"}),"\n",(0,r.jsx)(n.h3,{id:"keycloak-urls",children:"Keycloak URLs"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Realm identifier:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"tenant-{TENANT_ID}-event-{EVENT_ID}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"IdP metadata endpoint:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"{SP_BASE_URL}/realms/{REALM_ID}/broker/{IDP_ALIAS}/endpoint/descriptor\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"ACS URL:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"{SP_BASE_URL}/realms/{REALM_ID}/broker/{IDP_ALIAS}/endpoint/clients/{CLIENT_ID}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Redirect provider endpoint:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"{SP_BASE_URL}/realms/{REALM_ID}/redirect-provider/redirect\n"})}),"\n",(0,r.jsx)(n.h3,{id:"voting-portal-urls",children:"Voting Portal URLs"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Login page:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"{VOTING_PORTAL_URL}/tenant/{TENANT_ID}/event/{EVENT_ID}/login\n"})}),"\n",(0,r.jsx)(n.h3,{id:"simplesamlphp-reference-files",children:"SimpleSAMLphp Reference Files"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Configuration:"})," ",(0,r.jsx)(n.code,{children:".devcontainer/simplesamlphp/config.php"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Environment:"})," ",(0,r.jsx)(n.code,{children:".devcontainer/simplesamlphp/.env.example"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"IdP Metadata:"})," ",(0,r.jsx)(n.code,{children:".devcontainer/simplesamlphp/metadata/saml20-idp-hosted.php"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"SP Metadata:"})," ",(0,r.jsx)(n.code,{children:".devcontainer/simplesamlphp/metadata/saml20-sp-remote.php"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Trigger Page:"})," ",(0,r.jsx)(n.code,{children:".devcontainer/simplesamlphp/public/idp-initiated-sso.php"})]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"additional-resources",children:"Additional Resources"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Third-Party Integration Guide:"})," ",(0,r.jsx)(n.a,{href:"../../integrations/idp_initiated_sso_integration_guide",children:"IdP-Initiated SSO Integration Guide"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Internal Design Documentation:"})," ",(0,r.jsx)(n.a,{href:"../Keycloak/idp_initiated_sso_design_implementation",children:"IdP-Initiated SSO Design & Implementation"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"SimpleSAMLphp Reference:"})," ",(0,r.jsx)(n.code,{children:".devcontainer/simplesamlphp/README.md"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Keycloak Documentation:"})," ",(0,r.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_admin/#_identity_broker",children:"https://www.keycloak.org/docs/latest/server_admin/#_identity_broker"})]}),"\n"]})]})}function a(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},8212:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/simplesamlphp_admin_portal-89ad8dd80d7d1e3b2ad37949d9e4154e.png"},8453:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>d});var s=i(6540);const r={},l=s.createContext(r);function t(e){const n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);