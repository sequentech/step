"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[7909],{2569:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"developers/Velvet/velvet_instant_runoff","title":"Instant Runoff Algorithm","description":"\x3c!--","source":"@site/docs/developers/07-Velvet/05-instant-runoff.md","sourceDirName":"developers/07-Velvet","slug":"/developers/Velvet/velvet_instant_runoff","permalink":"/docusaurus/pr-preview/pr-2068/docs/developers/Velvet/velvet_instant_runoff","draft":false,"unlisted":false,"editUrl":"https://github.com/sequentech/step/docs/docusaurus/docs/developers/07-Velvet/05-instant-runoff.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"id":"velvet_instant_runoff","title":"Instant Runoff Algorithm","sidebar_position":5},"sidebar":"docs","previous":{"title":"Counting Algorithms","permalink":"/docusaurus/pr-preview/pr-2068/docs/developers/Velvet/velvet_algorithms"},"next":{"title":"Command Line Interface","permalink":"/docusaurus/pr-preview/pr-2068/docs/developers/Velvet/velvet_cli"}}');var s=i(4848),l=i(8453);const a={id:"velvet_instant_runoff",title:"Instant Runoff Algorithm",sidebar_position:5},r="Instant Runoff Voting Algorithm",d={},o=[{value:"Algorithm Overview",id:"algorithm-overview",level:2},{value:"Key Features",id:"key-features",level:2},{value:"Implementation Details",id:"implementation-details",level:2},{value:"Location",id:"location",level:3},{value:"Core Structures",id:"core-structures",level:3},{value:"ECandidateStatus",id:"ecandidatestatus",level:4},{value:"BallotStatus",id:"ballotstatus",level:4},{value:"Round",id:"round",level:4},{value:"RunoffStatus",id:"runoffstatus",level:4},{value:"Algorithm Flow",id:"algorithm-flow",level:3},{value:"1. Initialization",id:"1-initialization",level:4},{value:"2. Round Execution",id:"2-round-execution",level:4},{value:"3. Vote Redistribution",id:"3-vote-redistribution",level:4},{value:"4. Elimination Logic",id:"4-elimination-logic",level:4},{value:"5. Tie-Breaking (Look-Back Rule)",id:"5-tie-breaking-look-back-rule",level:4},{value:"Winner Determination",id:"winner-determination",level:3},{value:"Result Calculation",id:"result-calculation",level:3},{value:"Results for each round",id:"results-for-each-round",level:3},{value:"Edge Cases",id:"edge-cases",level:3},{value:"Exhausted Ballots",id:"exhausted-ballots",level:4},{value:"Simultaneous Elimination",id:"simultaneous-elimination",level:4},{value:"Winner Tie",id:"winner-tie",level:4},{value:"Maximum Rounds",id:"maximum-rounds",level:4},{value:"Testing",id:"testing",level:2},{value:"Unit Tests",id:"unit-tests",level:3},{value:"Integration Tests",id:"integration-tests",level:3},{value:"Usage Example",id:"usage-example",level:2},{value:"Performance Considerations",id:"performance-considerations",level:2},{value:"References",id:"references",level:2}];function c(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"instant-runoff-voting-algorithm",children:"Instant Runoff Voting Algorithm"})}),"\n",(0,s.jsx)(n.p,{children:"The Instant Runoff Voting (IRV) algorithm, also known as Ranked-Choice Voting (RCV) or Alternative Vote, is a single-winner electoral system where voters rank candidates in order of preference."}),"\n",(0,s.jsx)(n.h2,{id:"algorithm-overview",children:"Algorithm Overview"}),"\n",(0,s.jsx)(n.p,{children:"In IRV, if no candidate receives a majority of first-preference votes, the candidate with the fewest votes is eliminated. Votes for the eliminated candidate are then redistributed to each voter's next preference. This process continues until a candidate achieves a majority or a tie condition is reached."}),"\n",(0,s.jsx)(n.h2,{id:"key-features",children:"Key Features"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Ranked ballots"})," - Voters rank candidates in order of preference"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Majority requirement"})," - A candidate must receive more than 50% of active votes to win"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Elimination rounds"})," - Candidates with the fewest votes are eliminated sequentially"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Vote redistribution"})," - When a candidate is eliminated, their votes transfer to the next-ranked active candidate"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Exhausted ballots"})," - Ballots with no remaining valid choices become exhausted and are removed from the count"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Tie-breaking"})," - Look-back rule attempts to break ties by examining previous rounds"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"implementation-details",children:"Implementation Details"}),"\n",(0,s.jsx)(n.h3,{id:"location",children:"Location"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"File"}),": ",(0,s.jsx)(n.code,{children:"/packages/velvet/src/pipes/do_tally/counting_algorithm/instant_runoff.rs"})]}),"\n",(0,s.jsx)(n.h3,{id:"core-structures",children:"Core Structures"}),"\n",(0,s.jsx)(n.h4,{id:"ecandidatestatus",children:"ECandidateStatus"}),"\n",(0,s.jsx)(n.p,{children:"Tracks whether a candidate is still active or has been eliminated:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"pub enum ECandidateStatus {\n    Active,\n    Eliminated,\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"ballotstatus",children:"BallotStatus"}),"\n",(0,s.jsx)(n.p,{children:"Tracks the state of each ballot throughout the counting process:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"enum BallotStatus {\n    Valid,      // Ballot is still counting\n    Exhausted,  // No more valid choices remain\n    Invalid,    // Ballot is invalid\n    Blank,      // Ballot has no selections\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"round",children:"Round"}),"\n",(0,s.jsx)(n.p,{children:"Represents the results of a single elimination round:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"pub struct Round {\n    pub winner: Option<String>,\n    pub candidates_wins: CandidatesWins,  // Vote count for each candidate\n    pub eliminated_candidates: Option<Vec<String>>,\n    pub active_candidates_count: u64,\n    pub active_ballots_count: u64,\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"runoffstatus",children:"RunoffStatus"}),"\n",(0,s.jsx)(n.p,{children:"Manages the overall state of the IRV process:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"pub struct RunoffStatus {\n    pub candidates_status: CandidatesStatus,\n    pub round_count: u64,\n    pub rounds: Vec<Round>,\n    pub max_rounds: u64,\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"algorithm-flow",children:"Algorithm Flow"}),"\n",(0,s.jsx)(n.h4,{id:"1-initialization",children:"1. Initialization"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"fn initialize_statuses(votes: &Vec<(DecodedVoteContest, Weight)>, contest: &Contest) -> BallotsStatus\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Classify each ballot as valid, invalid, or blank"}),"\n",(0,s.jsx)(n.li,{children:"Count explicit and implicit invalid votes"}),"\n",(0,s.jsx)(n.li,{children:"Calculate initial metrics"}),"\n",(0,s.jsxs)(n.li,{children:["All candidates start with ",(0,s.jsx)(n.code,{children:"Active"})," status"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"2-round-execution",children:"2. Round Execution"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"fn run_next_round(&mut self, ballots_status: &mut BallotsStatus) -> bool\n"})}),"\n",(0,s.jsx)(n.p,{children:"For each round:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Count first preferences"})," - For each active ballot, find the highest-ranked candidate who hasn't been eliminated"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Check for winner"})," - If any candidate has > 50% of active votes, they win"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Eliminate candidates"})," - If no winner, eliminate the candidate(s) with the fewest votes"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Update ballot status"})," - Mark ballots as exhausted if they have no more valid preferences"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Record round"})," - Store results for this round"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"3-vote-redistribution",children:"3. Vote Redistribution"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"fn find_first_active_choice(&self, choices: &Vec<DecodedVoteChoice>, active_candidates: &Vec<String>) -> Option<String>\n"})}),"\n",(0,s.jsx)(n.p,{children:"When counting votes in a round:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Examine each ballot's ranked choices in order"}),"\n",(0,s.jsx)(n.li,{children:"Skip eliminated candidates"}),"\n",(0,s.jsx)(n.li,{children:"Assign the vote to the first active candidate in the ranking"}),"\n",(0,s.jsx)(n.li,{children:"If no active candidates remain on the ballot, mark it as exhausted"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"4-elimination-logic",children:"4. Elimination Logic"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"fn do_round_eliminations(&mut self, candidates_wins: &CandidatesWins, candidates_to_eliminate: &Vec<String>) -> Option<Vec<String>>\n"})}),"\n",(0,s.jsx)(n.p,{children:"When eliminating candidates:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Find the candidate(s) with the fewest votes"}),"\n",(0,s.jsx)(n.li,{children:"If there's a tie for fewest votes, apply the look-back rule"}),"\n",(0,s.jsx)(n.li,{children:"If all remaining candidates are tied, no elimination occurs (tie for winner)"}),"\n",(0,s.jsx)(n.li,{children:"Simultaneous elimination can occur when multiple candidates have the same fewest votes and can't be broken by look-back"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"5-tie-breaking-look-back-rule",children:"5. Tie-Breaking (Look-Back Rule)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"fn find_single_candidate_to_eliminate(&self, candidates_to_eliminate: &Vec<String>) -> Vec<String>\n"})}),"\n",(0,s.jsx)(n.p,{children:"When multiple candidates are tied for elimination:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Go back to the previous round"}),"\n",(0,s.jsx)(n.li,{children:"Compare vote counts in that round for the tied candidates"}),"\n",(0,s.jsx)(n.li,{children:"Eliminate the candidate with fewer votes in that round"}),"\n",(0,s.jsx)(n.li,{children:"If still tied, continue looking back through earlier rounds"}),"\n",(0,s.jsx)(n.li,{children:"If all rounds are exhausted and tie persists, all tied candidates may be eliminated simultaneously"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"winner-determination",children:"Winner Determination"}),"\n",(0,s.jsxs)(n.p,{children:["A candidate wins if they receive ",(0,s.jsx)(n.strong,{children:"more than 50%"})," of active votes in a round:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"let max_wins = candidates_wins.values().max().unwrap_or(&0);\nif *max_wins > act_ballots / 2 {\n    // Winner found\n    round.winner = Some(candidate_id);\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"result-calculation",children:"Result Calculation"}),"\n",(0,s.jsxs)(n.p,{children:["The final ",(0,s.jsx)(n.code,{children:"ContestResult"})," includes:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Vote counts"})," - Total votes for each candidate in the final/winning round"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Percentages"})," - Calculated based on valid votes (excluding blanks)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Invalid votes"})," - Separated into explicit and implicit"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Blank votes"})," - Counted separately"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Extended metrics"})," - Total ballots, participation rates, etc."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Percentages are calculated as:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"For regular candidates"}),": ",(0,s.jsx)(n.code,{children:"(total_count / (count_valid - count_blank)) * 100"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"For explicit blank"}),": ",(0,s.jsx)(n.code,{children:"(count_blank / total_ballots) * 100"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"For explicit invalid"}),": ",(0,s.jsx)(n.code,{children:"(explicit_invalid / total_ballots) * 100"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"results-for-each-round",children:"Results for each round"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"Documentation to be added."})}),"\n",(0,s.jsx)(n.h3,{id:"edge-cases",children:"Edge Cases"}),"\n",(0,s.jsx)(n.h4,{id:"exhausted-ballots",children:"Exhausted Ballots"}),"\n",(0,s.jsx)(n.p,{children:"When a ballot's ranked preferences are exhausted (all preferred candidates eliminated):"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["The ballot is marked as ",(0,s.jsx)(n.code,{children:"Exhausted"})]}),"\n",(0,s.jsx)(n.li,{children:"It no longer counts in the active ballot total"}),"\n",(0,s.jsx)(n.li,{children:"The majority threshold is recalculated based on remaining active ballots"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"simultaneous-elimination",children:"Simultaneous Elimination"}),"\n",(0,s.jsx)(n.p,{children:"When multiple candidates are tied for fewest votes and the tie cannot be broken:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"All tied candidates may be eliminated simultaneously"}),"\n",(0,s.jsx)(n.li,{children:"This can create corner cases in some scenarios"}),"\n",(0,s.jsx)(n.li,{children:"Some electoral systems handle this differently (e.g., random selection)"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"winner-tie",children:"Winner Tie"}),"\n",(0,s.jsx)(n.p,{children:"If all remaining candidates have equal votes and cannot be separated:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"No eliminations occur"}),"\n",(0,s.jsx)(n.li,{children:"The algorithm terminates"}),"\n",(0,s.jsx)(n.li,{children:"Winner determination is left to manual tie-breaking procedures"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"maximum-rounds",children:"Maximum Rounds"}),"\n",(0,s.jsx)(n.p,{children:"A safety limit prevents infinite loops:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"let max_rounds = candidates.len() as u64 + 1;\n"})}),"\n",(0,s.jsx)(n.p,{children:"At least one candidate should be eliminated per round, so rounds shouldn't exceed the number of candidates plus one."}),"\n",(0,s.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,s.jsx)(n.p,{children:"The IRV algorithm has comprehensive test coverage:"}),"\n",(0,s.jsx)(n.h3,{id:"unit-tests",children:"Unit Tests"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"File"}),": ",(0,s.jsx)(n.code,{children:"/packages/velvet/tests/irv_unit_tests.rs"})]}),"\n",(0,s.jsx)(n.p,{children:"Tests individual components:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Ballot status initialization"}),"\n",(0,s.jsx)(n.li,{children:"Vote redistribution logic"}),"\n",(0,s.jsx)(n.li,{children:"Elimination logic"}),"\n",(0,s.jsx)(n.li,{children:"Tie-breaking rules"}),"\n",(0,s.jsx)(n.li,{children:"Edge cases"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"integration-tests",children:"Integration Tests"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"File"}),": ",(0,s.jsx)(n.code,{children:"/packages/velvet/tests/irv_integration_tests.rs"})]}),"\n",(0,s.jsx)(n.p,{children:"Tests complete IRV tallies:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Simple majority cases"}),"\n",(0,s.jsx)(n.li,{children:"Multi-round eliminations"}),"\n",(0,s.jsx)(n.li,{children:"Exhausted ballot handling"}),"\n",(0,s.jsx)(n.li,{children:"Tie scenarios"}),"\n",(0,s.jsx)(n.li,{children:"Complex real-world examples"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Run tests with:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cargo test instant_runoff\ncargo test irv\n"})}),"\n",(0,s.jsx)(n.h2,{id:"usage-example",children:"Usage Example"}),"\n",(0,s.jsxs)(n.p,{children:["The InstantRunoff algorithm is configured in the election's contest configuration. When the tally is executed, Velvet automatically uses the IRV algorithm based on the contest's ",(0,s.jsx)(n.code,{children:"tally_type"})," setting."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"pub struct InstantRunoff {\n    pub tally: Tally,\n}\n\nimpl CountingAlgorithm for InstantRunoff {\n    fn tally(&self) -> Result<ContestResult> {\n        // Initialize ballot and candidate statuses\n        let mut ballots_status = BallotsStatus::initialize_statuses(votes, contest);\n        let mut runoff = RunoffStatus::initialize_statuses(&contest.candidates);\n        \n        // Run elimination rounds until winner or tie\n        runoff.run(&mut ballots_status);\n        \n        // Generate and return results\n        // ...\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"performance-considerations",children:"Performance Considerations"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Memory"}),": The algorithm stores all ballots in memory with their statuses"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Complexity"}),": O(n \xd7 m \xd7 r) where n = ballots, m = candidates, r = rounds"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Typical rounds"}),": Most elections conclude in 2-4 rounds"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Worst case"}),": Maximum rounds equals number of candidates"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"IRV is used in various jurisdictions worldwide including Australia, Ireland, and many U.S. cities"}),"\n",(0,s.jsx)(n.li,{children:"Also known as: Ranked-Choice Voting (RCV), Alternative Vote (AV), Preferential Voting"}),"\n",(0,s.jsx)(n.li,{children:"Single-winner variant of the Single Transferable Vote (STV) system"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>r});var t=i(6540);const s={},l=t.createContext(s);function a(e){const n=t.useContext(l);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);