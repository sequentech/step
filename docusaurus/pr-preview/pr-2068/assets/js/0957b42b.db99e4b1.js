"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3468],{1661:(e,n,l)=>{l.r(n),l.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"developers/Velvet/velvet_tally","title":"Tally Engine","description":"\x3c!--","source":"@site/docs/developers/07-Velvet/03-tally.md","sourceDirName":"developers/07-Velvet","slug":"/developers/Velvet/velvet_tally","permalink":"/docusaurus/pr-preview/pr-2068/docs/developers/Velvet/velvet_tally","draft":false,"unlisted":false,"editUrl":"https://github.com/sequentech/step/edit/main/docs/docusaurus/docs/developers/07-Velvet/03-tally.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"id":"velvet_tally","title":"Tally Engine","sidebar_position":3},"sidebar":"docs","previous":{"title":"Pipes","permalink":"/docusaurus/pr-preview/pr-2068/docs/developers/Velvet/velvet_pipes"},"next":{"title":"Counting Algorithms","permalink":"/docusaurus/pr-preview/pr-2068/docs/developers/Velvet/velvet_algorithms"}}');var i=l(4848),t=l(8453);const r={id:"velvet_tally",title:"Tally Engine",sidebar_position:3},o="Tally Engine",a={},d=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Ballot Processing",id:"ballot-processing",level:2},{value:"Invalid Votes",id:"invalid-votes",level:2},{value:"Extended Metrics",id:"extended-metrics",level:2},{value:"Result Structure",id:"result-structure",level:2},{value:"Configurable tally operations",id:"configurable-tally-operations",level:2},{value:"Available operations",id:"available-operations",level:3},{value:"Contest-level configuration",id:"contest-level-configuration",level:3},{value:"Area-level configuration",id:"area-level-configuration",level:3},{value:"Summary of defaults",id:"summary-of-defaults",level:3},{value:"Location",id:"location",level:2}];function c(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"tally-engine",children:"Tally Engine"})}),"\n",(0,i.jsx)(n.p,{children:"The tally engine is the core component responsible for counting votes and determining election results."}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"The tally engine processes decoded ballots using a specified counting algorithm to produce:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Vote totals for each candidate"}),"\n",(0,i.jsx)(n.li,{children:"Percentage of votes received"}),"\n",(0,i.jsx)(n.li,{children:"Valid, invalid, and blank vote counts"}),"\n",(0,i.jsx)(n.li,{children:"Extended metrics for analysis"}),"\n",(0,i.jsx)(n.li,{children:"Winner determination (if applicable)"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,i.jsxs)(n.p,{children:["The tally engine is implemented in the ",(0,i.jsx)(n.code,{children:"do_tally"})," pipe and consists of:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Tally struct"})," - Holds ballot data, contest configuration, and census information"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Counting algorithms"})," - Pluggable algorithms that implement different electoral systems"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Result aggregation"})," - Combines results from multiple areas or districts"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Metrics tracking"})," - Records detailed statistics about the voting process"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"ballot-processing",children:"Ballot Processing"}),"\n",(0,i.jsx)(n.p,{children:"Ballots go through several stages:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Validation"})," - Check if ballots are valid, invalid, or blank"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Counting"})," - Apply the counting algorithm based on the electoral system"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Aggregation"})," - Combine results from multiple voting areas"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Metric calculation"})," - Compute percentages and statistics"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"invalid-votes",children:"Invalid Votes"}),"\n",(0,i.jsx)(n.p,{children:"The tally engine handles different types of invalid votes:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Explicit invalid"})," - Voter intentionally marked ballot as invalid"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Implicit invalid"})," - Ballot is invalid due to errors (e.g., overvoting)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Blank votes"})," - Ballot has no selections"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Invalid vote handling can be configured per election."}),"\n",(0,i.jsx)(n.h2,{id:"extended-metrics",children:"Extended Metrics"}),"\n",(0,i.jsx)(n.p,{children:"The tally engine tracks detailed metrics including:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Total ballots cast"}),"\n",(0,i.jsx)(n.li,{children:"Number of valid ballots"}),"\n",(0,i.jsx)(n.li,{children:"Number of invalid ballots (explicit and implicit)"}),"\n",(0,i.jsx)(n.li,{children:"Number of blank ballots"}),"\n",(0,i.jsx)(n.li,{children:"Voter participation rates"}),"\n",(0,i.jsx)(n.li,{children:"Per-candidate vote distributions"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"result-structure",children:"Result Structure"}),"\n",(0,i.jsx)(n.p,{children:"Tally results include:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:"ContestResult {\n    contest: Contest,\n    census: u64,\n    auditable_votes: u64,\n    total_votes: u64,\n    total_valid_votes: u64,\n    total_invalid_votes: u64,\n    total_blank_votes: u64,\n    candidate_result: Vec<CandidateResult>,\n    extended_metrics: ExtendedMetricsContest,\n    // ... percentage fields\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Each candidate result contains:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:"CandidateResult {\n    candidate: Candidate,\n    total_count: u64,\n    percentage_votes: f64,\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"configurable-tally-operations",children:"Configurable tally operations"}),"\n",(0,i.jsxs)(n.p,{children:["The tally engine can be configured to perform different operations at ",(0,i.jsx)(n.strong,{children:"contest"})," and ",(0,i.jsx)(n.strong,{children:"area"})," level. This is controlled by the ",(0,i.jsx)(n.code,{children:"tally_operation"})," setting, which determines whether ballots are processed in detail or results are just aggregated."]}),"\n",(0,i.jsx)(n.h3,{id:"available-operations",children:"Available operations"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"tally_operation"})," value must be one of the variants of the ",(0,i.jsx)(n.code,{children:"TallyOperation"})," enum:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"process-ballots-all"})})," (",(0,i.jsx)(n.code,{children:"TallyOperation::ProcessBallotsAll"}),")","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Processes all ballots in the scope (contest or area)."}),"\n",(0,i.jsx)(n.li,{children:"Produces full candidate results and participation statistics."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"aggregate-results"})})," (",(0,i.jsx)(n.code,{children:"TallyOperation::AggregateResults"}),")","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Does ",(0,i.jsx)(n.strong,{children:"not"})," re-process ballots."]}),"\n",(0,i.jsx)(n.li,{children:"Aggregates candidate results that were already computed in lower-level areas."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"skip-candidate-results"})})," (",(0,i.jsx)(n.code,{children:"TallyOperation::SkipCandidateResults"}),")","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Processes ballots only to compute participation statistics."}),"\n",(0,i.jsxs)(n.li,{children:["Does ",(0,i.jsx)(n.strong,{children:"not"})," generate candidate-level results in that scope."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"contest-level-configuration",children:"Contest-level configuration"}),"\n",(0,i.jsxs)(n.p,{children:["At contest level, the tally operation is read from the contest ",(0,i.jsx)(n.code,{children:"annotations"})," JSON as the ",(0,i.jsx)(n.code,{children:"tally_operation"})," key:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Location"}),": ",(0,i.jsx)(n.code,{children:'contest.annotations["tally_operation"]'})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Type"}),": string"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Allowed values"}),": ",(0,i.jsx)(n.code,{children:'"process-ballots-all"'}),", ",(0,i.jsx)(n.code,{children:'"aggregate-results"'}),", ",(0,i.jsx)(n.code,{children:'"skip-candidate-results"'})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["If ",(0,i.jsx)(n.code,{children:"tally_operation"})," is ",(0,i.jsx)(n.strong,{children:"not present"}),", empty, or contains an unknown value, the engine falls back to a default that depends on the counting algorithm (",(0,i.jsx)(n.code,{children:"CountingAlgType"}),"):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["For ",(0,i.jsx)(n.strong,{children:"preferential (ranked-choice)"})," algorithms (",(0,i.jsx)(n.code,{children:"instant-runoff"}),", ",(0,i.jsx)(n.code,{children:"borda"}),", ",(0,i.jsx)(n.code,{children:"borda-nauru"}),", ",(0,i.jsx)(n.code,{children:"borda-mas-madrid"}),", ",(0,i.jsx)(n.code,{children:"pairwise-beta"}),", ",(0,i.jsx)(n.code,{children:"desborda"}),", ",(0,i.jsx)(n.code,{children:"desborda2"}),", ",(0,i.jsx)(n.code,{children:"desborda3"}),"):","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Default contest operation"}),": ",(0,i.jsx)(n.code,{children:"process-ballots-all"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["For ",(0,i.jsx)(n.strong,{children:"non-preferential"})," algorithms (e.g. ",(0,i.jsx)(n.code,{children:"plurality-at-large"}),", ",(0,i.jsx)(n.code,{children:"cumulative"}),"):","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Default contest operation"}),": ",(0,i.jsx)(n.code,{children:"aggregate-results"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["This behavior is implemented by ",(0,i.jsx)(n.code,{children:"get_contest_tally_operation"}),", which parses ",(0,i.jsx)(n.code,{children:"tally_operation"})," and falls back to ",(0,i.jsx)(n.code,{children:"CountingAlgType::get_default_tally_operation_for_contest()"})," when needed."]}),"\n",(0,i.jsx)(n.h3,{id:"area-level-configuration",children:"Area-level configuration"}),"\n",(0,i.jsxs)(n.p,{children:["At area level, the tally operation is configured via the ",(0,i.jsx)(n.code,{children:"area_annotations"})," associated with each ",(0,i.jsx)(n.code,{children:"BallotStyle"})," and the area identifier:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Source"}),": the ",(0,i.jsx)(n.code,{children:"BallotStyle"})," entry whose ",(0,i.jsx)(n.code,{children:"area_id"})," matches the area being tallied."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Location"}),": ",(0,i.jsx)(n.code,{children:"ballot_style.area_annotations.tally_operation"})," (internally accessed via ",(0,i.jsx)(n.code,{children:"get_tally_operation()"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Type"}),": string"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Allowed values"}),": same as contest level \u2013 ",(0,i.jsx)(n.code,{children:'"process-ballots-all"'}),", ",(0,i.jsx)(n.code,{children:'"aggregate-results"'}),", ",(0,i.jsx)(n.code,{children:'"skip-candidate-results"'}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["If no matching ",(0,i.jsx)(n.code,{children:"BallotStyle"})," is found for an area, or if ",(0,i.jsx)(n.code,{children:"tally_operation"})," is missing/invalid in ",(0,i.jsx)(n.code,{children:"area_annotations"}),", the engine uses a default that also depends on the counting algorithm:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["For ",(0,i.jsx)(n.strong,{children:"preferential (ranked-choice)"})," algorithms:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Default area operation"}),": ",(0,i.jsx)(n.code,{children:"skip-candidate-results"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["For ",(0,i.jsx)(n.strong,{children:"non-preferential"})," algorithms:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Default area operation"}),": ",(0,i.jsx)(n.code,{children:"process-ballots-all"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["This behavior is implemented by ",(0,i.jsx)(n.code,{children:"get_area_tally_operation"}),", which selects the corresponding ",(0,i.jsx)(n.code,{children:"BallotStyle"}),", queries its ",(0,i.jsx)(n.code,{children:"area_annotations"}),", and falls back to ",(0,i.jsx)(n.code,{children:"CountingAlgType::get_default_tally_operation_for_area()"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"summary-of-defaults",children:"Summary of defaults"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Counting algorithm type"}),(0,i.jsx)(n.th,{children:"Contest default"}),(0,i.jsx)(n.th,{children:"Area default"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Preferential (ranked-choice)"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"process-ballots-all"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"skip-candidate-results"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Non-preferential"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"aggregate-results"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"process-ballots-all"})})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["When in doubt or when configuration is missing, the tally engine will always choose a safe default based on the counting algorithm, so tallying can proceed even without explicit ",(0,i.jsx)(n.code,{children:"tally_operation"})," settings."]}),"\n",(0,i.jsx)(n.h2,{id:"location",children:"Location"}),"\n",(0,i.jsxs)(n.p,{children:["Tally engine implementation: ",(0,i.jsx)(n.code,{children:"/packages/velvet/src/pipes/do_tally/"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"Further documentation to be added."})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453:(e,n,l)=>{l.d(n,{R:()=>r,x:()=>o});var s=l(6540);const i={},t=s.createContext(i);function r(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);