# SPDX-FileCopyrightText: 2023 Eduardo Robles <edu@sequentech.io>
#
# SPDX-License-Identifier: AGPL-3.0-only
[[tests]]
description = "Simple permissions: should work"
data = """{
    "users": [{
        "name": "admin",
        "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
        "metadata": {}
    }],
    "roles": [{
        "name": "admins",
        "permissions": ["AddEntries"],
        "metadata": {}
    }],
    "user_roles": [{
        "user_name": "admin",
        "role_names": ["admins"]
    }]
}"""

[[tests]]
description = "Simple permissions: multiple users, roles, etc"
data = """{
    "users": [
        {
            "name": "admin1",
            "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
            "metadata": {
                "somekey": "some data whatever",
                "some other këy": "something else"
            }
        },
        {
            "name": "admin2",
            "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
            "metadata": {}
        },
        {
            "name": "user3",
            "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
            "metadata": {}
        }
    ],
    "roles": [
        {
            "name": "admins",
            "permissions": ["AddEntries", "ChangeBoard"],
            "metadata": {
                "no identifier validations here": "whatever ñ+p goes"
            }
        },
        {
            "name": "writers",
            "permissions": ["AddEntries"],
            "metadata": {}
        }
    ],
    "user_roles": [
        {
            "user_name": "admin1",
            "role_names": ["admins", "writers"]
        },
        {
            "user_name": "admin2",
            "role_names": ["admins"]
        },
        {
            "user_name": "user3",
            "role_names": []
        }
    ]
}"""


[[tests]]
description = "Invalid parse error, json is invalid (missing opening '{' character)"
data = """
    "users": [{
        "name": "admin",
        "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
        "metadata": {}
    }],
    "roles": [{
        "name": "admins",
        "permissions": ["AddEntries"],
        "metadata": {}
    }],
    "user_roles": [{
        "user_name": "admin",
        "role_names": ["admins"]
    }]
}"""
parse_error = """Err(Error(\"invalid type: string \\\"users\\\", expected struct Permissions\", line: 1, column: 11))"""

[[tests]]
description = "Invalid public key for user admin"
data = """{
    "users": [{
        "name": "admin",
        "public_key": "whatever",
        "metadata": {}
    }],
    "roles": [{
        "name": "admins",
        "permissions": ["AddEntries"],
        "metadata": {}
    }],
    "user_roles": [{
        "user_name": "admin",
        "role_names": ["admins"]
    }]
}"""
validate_error = """Err(ErrorDecodingPublicKey(\"admin\"))"""

[[tests]]
description = "user name is not a valid identifier"
data = """{
    "users": [{
        "name": "ad!min",
        "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
        "metadata": {}
    }],
    "roles": [{
        "name": "admins",
        "permissions": ["AddEntries"],
        "metadata": {}
    }],
    "user_roles": [{
        "user_name": "ad!min",
        "role_names": ["admins"]
    }]
}"""
validate_error = """Err(InvalidIdentifier(\"user.name\", \"ad!min\"))"""

[[tests]]
description = "role name is not a valid identifier"
data = """{
    "users": [{
        "name": "admin",
        "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
        "metadata": {}
    }],
    "roles": [{
        "name": "admiñs",
        "permissions": ["AddEntries"],
        "metadata": {}
    }],
    "user_roles": [{
        "user_name": "ad!min",
        "role_names": ["admiñs"]
    }]
}"""
validate_error = """Err(InvalidIdentifier(\"role.name\", \"admiñs\"))"""

[[tests]]
description = "Role permission is not a valid identifier"
data = """{
    "users": [{
        "name": "admin",
        "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
        "metadata": {}
    }],
    "roles": [{
        "name": "admins",
        "permissions": ["Add Entries"],
        "metadata": {}
    }],
    "user_roles": [{
        "user_name": "admin",
        "role_names": ["admins"]
    }]
}"""
validate_error = """Err(InvalidIdentifier(\"role.permissions[i]\", \"Add Entries\"))"""

[[tests]]
description = "Repeated username"
data = """{
    "users": [
        {
            "name": "admin",
            "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
            "metadata": {}
        },
        {
            "name": "admin",
            "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
            "metadata": {}
        }
    ],
    "roles": [{
        "name": "admins",
        "permissions": ["Add Entries"],
        "metadata": {}
    }],
    "user_roles": [{
        "user_name": "admin",
        "role_names": ["admins"]
    }]
}"""
validate_error = "Err(DuplicatedUserNames)"


[[tests]]
description = "Empty user list"
data = """{
    "users": [],
    "roles": [{
        "name": "admins",
        "permissions": ["Add Entries"],
        "metadata": {}
    }],
    "user_roles": [{
        "user_name": "admin",
        "role_names": ["admins"]
    }]
}"""
validate_error = "Err(EmptyUserList)"

[[tests]]
description = "Empty role list"
data = """{
    "users": [
        {
            "name": "admin",
            "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
            "metadata": {}
        }
    ],
    "roles": [],
    "user_roles": [{
        "user_name": "admin",
        "role_names": ["admins"]
    }]
}"""
validate_error = "Err(EmptyRoleList)"


[[tests]]
description = "Empty user roles list"
data = """{
    "users": [
        {
            "name": "admin",
            "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
            "metadata": {}
        }
    ],
    "roles": [{
        "name": "admins",
        "permissions": ["Add Entries"],
        "metadata": {}
    }],
    "user_roles": []
}"""
validate_error = "Err(EmptyUserRoleList)"

[[tests]]
description = "Contains duplicated role names"
data = """{
    "users": [{
        "name": "admin",
        "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
        "metadata": {}
    }],
    "roles": [
        {
            "name": "admins",
            "permissions": ["AddEntries"],
            "metadata": {}
        },
        {
            "name": "admins",
            "permissions": ["Whatever"],
            "metadata": {}
        }
    ],
    "user_roles": [{
        "user_name": "admin",
        "role_names": ["admins"]
    }]
}"""
validate_error = "Err(DuplicatedRoleNames)"

[[tests]]
description = "User not found"
data = """{
    "users": [{
        "name": "admin",
        "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
        "metadata": {}
    }],
    "roles": [{
        "name": "admins",
        "permissions": ["AddEntries"],
        "metadata": {}
    }],
    "user_roles": [{
        "user_name": "invalid-admin-name",
        "role_names": ["admins"]
    }]
}"""
validate_error = "Err(UserNotFound(\"invalid-admin-name\"))"

[[tests]]
description = "Role not found"
data = """{
    "users": [{
        "name": "admin",
        "public_key": "gS2o6mE/9PmDYXHqcqKfyfHSVsoKuEip+olBk3YiQCM",
        "metadata": {}
    }],
    "roles": [{
        "name": "admins",
        "permissions": ["AddEntries"],
        "metadata": {}
    }],
    "user_roles": [{
        "user_name": "admin",
        "role_names": ["inexistent-role-name"]
    }]
}"""
validate_error = "Err(RoleNotFound(\"inexistent-role-name\"))"
